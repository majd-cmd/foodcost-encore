<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculateur Food Cost Pro - v4.0 CLOUD SYNC</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- LZ-String compression library for URL sharing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <!-- Chart.js for margin visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #ec4899;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --border: #e2e8f0;
            --tva-color: #94a3b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.5;
            padding-bottom: 80px;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1.5rem 1rem;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.15);
            margin-bottom: 2rem;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 { font-size: 1.5rem; font-weight: 800; display: flex; align-items: center; gap: 12px; letter-spacing: -0.025em; }
        
        .header-actions button {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.25);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            backdrop-filter: blur(4px);
        }
        .header-actions button:hover { background: rgba(255,255,255,0.25); transform: translateY(-1px); }

        /* Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .container { grid-template-columns: 1fr; }
            aside .card { position: static !important; max-height: 300px; overflow: hidden; display: flex; flex-direction: column; }
            .ingredient-list { flex: 1; overflow-y: auto; }
        }

        /* ===== MOBILE TOGGLE BUTTON ===== */
        .mobile-ing-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
            cursor: pointer;
            z-index: 999;
            font-size: 1.2rem;
            transition: transform 0.2s;
        }
        .mobile-ing-toggle:hover {
            transform: scale(1.1);
        }
        .mobile-ing-toggle.active {
            background: var(--danger);
        }

        /* Mobile sidebar overlay */
        .mobile-sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(2px);
        }
        .mobile-sidebar-overlay.show {
            display: block;
        }

        /* ===== MOBILE RESPONSIVE ===== */
        @media (max-width: 768px) {
            /* Body */
            body { padding-bottom: 80px; }

            /* Show toggle button */
            .mobile-ing-toggle { display: flex; align-items: center; justify-content: center; }

            /* Header */
            header { padding: 12px 10px; }
            .header-content {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            h1 {
                font-size: 1.1rem;
                flex-wrap: wrap;
                justify-content: center;
                text-align: center;
                width: 100%;
            }
            h1 .shared-badge,
            h1 .sync-indicator {
                margin: 5px 5px 0 5px;
                font-size: 0.65rem;
            }
            .header-actions {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
                width: 100%;
            }
            .header-actions button {
                padding: 8px 6px;
                font-size: 0.7rem;
                width: 100%;
            }
            .header-actions button i { margin-right: 4px; }

            /* Container */
            .container {
                padding: 0 10px;
                gap: 0;
                display: block;
            }

            /* HIDE SIDEBAR on mobile by default */
            aside {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 1001;
                background: var(--bg);
                padding: 15px;
                overflow-y: auto;
            }
            aside.mobile-show {
                display: block;
            }
            aside .card {
                position: relative !important;
                max-height: none;
                height: auto;
                margin-bottom: 70px;
            }
            aside .card h2 {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .ingredient-list {
                max-height: calc(100vh - 250px) !important;
                overflow-y: auto;
            }
            .ing-item { padding: 12px 10px; }
            .ing-name { font-size: 0.9rem; }
            .ing-price { font-size: 0.8rem; }
            .mobile-close-btn { display: inline-flex !important; }

            /* Main content - full width */
            main {
                width: 100%;
            }

            /* Cards */
            .card {
                padding: 12px;
                margin-bottom: 12px;
                border-radius: 12px;
            }

            /* Tabs - always visible */
            .tabs {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 12px;
            }
            .tab-btn {
                padding: 12px 8px;
                font-size: 0.9rem;
                border-radius: 10px;
            }

            /* Sub tabs - horizontal scroll */
            .sub-tabs-container {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                gap: 8px;
                padding-bottom: 10px;
                -webkit-overflow-scrolling: touch;
                margin-bottom: 10px;
            }
            .sub-tabs-container::-webkit-scrollbar { display: none; }
            .sub-tab {
                padding: 10px 16px;
                font-size: 0.85rem;
                flex-shrink: 0;
                white-space: nowrap;
            }
            .add-tab-btn {
                width: 36px;
                height: 36px;
                flex-shrink: 0;
            }

            /* Dashboard KPIs */
            .dashboard-row {
                grid-template-columns: 1fr 1fr 1fr !important;
                gap: 8px !important;
                margin-bottom: 15px !important;
            }
            .dash-kpi {
                padding: 10px 6px;
                border-radius: 10px;
            }
            .dash-kpi-val { font-size: 1.1rem; }
            .dash-kpi-lbl { font-size: 0.6rem; }
            .dash-kpi:nth-child(3) input { width: 40px; }

            /* Recipe header - horizontal buttons */
            .recipe-header {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
                gap: 8px;
            }
            .recipe-header input[type="text"] {
                font-size: 1rem !important;
                padding: 10px !important;
                flex: 1;
                min-width: 150px;
            }
            .recipe-header .btn {
                padding: 10px 12px;
                font-size: 0.85rem;
            }

            /* Tables */
            table { margin: 0.5rem 0; font-size: 0.85rem; }
            th { padding: 8px; font-size: 0.65rem; }
            td { padding: 8px; font-size: 0.85rem; }
            td input, td select {
                padding: 6px 8px;
                font-size: 0.85rem;
            }

            /* Recipe Stats */
            .recipe-stats {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }
            .stat-box { padding: 10px; }
            .stat-label { font-size: 0.7rem; }
            .stat-value { font-size: 1rem; }
            .stat-box:nth-child(2) {
                grid-column: span 2;
            }
            .stat-box .form-row {
                flex-wrap: wrap;
                gap: 8px;
            }
            .stat-box .form-row > div {
                flex: 1;
                min-width: 70px;
            }
            .stat-box .form-row input {
                padding: 6px;
                font-size: 0.85rem;
            }

            /* Profit Grid */
            .profit-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            .profit-card { padding: 12px; }
            .profit-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 8px;
            }
            .profit-card .form-group input {
                font-size: 1.2rem !important;
                padding: 8px !important;
            }
            .profit-card .form-row {
                flex-direction: row;
                gap: 10px;
            }
            .profit-card .form-row > div {
                flex: 1 !important;
            }
            .money-bar { height: 28px; margin: 8px 0 12px 0; }
            .bar-segment { font-size: 0.5rem; }
            .legend-row {
                padding: 5px 0;
                font-size: 0.8rem;
            }
            .final-row { font-size: 0.95rem; }

            /* Alerts */
            #marginAlerts { padding: 10px; }
            .alert-item {
                flex-direction: column;
                gap: 8px;
                padding: 10px;
            }
            .alert-item > div:last-child {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
            }
            .alert-item-btn { margin-left: 0; padding: 8px 12px; }

            /* Chart */
            .card:has(#marginChart) { padding: 10px; }
            .card:has(#marginChart) h2 { font-size: 0.9rem; flex-wrap: wrap; gap: 8px; }
            .card:has(#marginChart) > div:last-child { flex-wrap: wrap; gap: 10px; }

            /* Modals */
            #ingredientModal > .card,
            #editIngModal > .card,
            #shareModal > .card,
            #priceHistoryModal > .card {
                width: 95% !important;
                max-width: 95% !important;
                margin: 10px !important;
                max-height: 85vh;
                overflow-y: auto;
            }
            .share-url-container { flex-direction: column; gap: 10px; }
            .share-url-input { font-size: 0.75rem; }
            .copy-btn { width: 100%; }

            /* Form rows */
            .form-row { flex-wrap: wrap; gap: 8px; }
            .form-row > div { min-width: 80px; flex: 1; }

            /* Empty state */
            .empty-state { padding: 25px 15px; font-size: 0.9rem; }

            /* Hide chart legend text on very small */
            .card:has(#marginChart) > div:last-child > div span:last-child {
                font-size: 0.7rem;
            }
        }

        /* Extra small phones */
        @media (max-width: 400px) {
            h1 { font-size: 1rem; }
            .header-actions { grid-template-columns: 1fr 1fr; }
            .header-actions button { font-size: 0.65rem; padding: 7px 5px; }
            .dashboard-row { grid-template-columns: 1fr 1fr !important; }
            .dash-kpi:nth-child(3) { grid-column: span 2; }
            .tab-btn { padding: 10px 6px; font-size: 0.85rem; }
            .recipe-stats { grid-template-columns: 1fr !important; }
            .stat-box:nth-child(2) { grid-column: span 1; }
            .profit-card .form-row { flex-direction: column; }
            .profit-card .form-row > div { width: 100% !important; }
        }
        .card {
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        h2 {
            font-size: 1.1rem;
            color: var(--text);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
        }

        /* Ingredients Sidebar */
        .ingredient-list {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .ing-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            transition: background 0.2s;
            border-radius: 8px;
        }
        .ing-item:hover { background-color: #f1f5f9; }
        .ing-details { display: flex; flex-direction: column; }
        .ing-name { font-weight: 600; color: var(--text); }
        .ing-price { font-size: 0.8rem; color: var(--text-light); margin-top: 2px; }

        /* Inputs */
        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
            background: #f8fafc;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            background: white;
        }

        .form-group { margin-bottom: 1rem; }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn-primary { background-color: var(--primary); color: white; box-shadow: 0 2px 8px rgba(79, 70, 229, 0.25); }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-success { background-color: var(--success); color: white; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25); }
        .btn-danger { background-color: #fee2e2; color: var(--danger); }
        .btn-danger:hover { background-color: #fecaca; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; height: 28px; }

        /* Tables & Mobile Response */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin: 1rem 0; }
        th { text-align: left; font-size: 0.75rem; text-transform: uppercase; color: var(--text-light); padding: 12px; background: #f8fafc; border-bottom: 1px solid var(--border); font-weight: 600; letter-spacing: 0.05em; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        tr:last-child td { border-bottom: none; }

        /* Navigation Tabs */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .tab-btn {
            padding: 12px 24px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
            flex: 1;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .tab-btn:hover { background: #f8fafc; color: var(--primary); }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }

        /* Sub Tabs */
        .sub-tabs-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            padding-bottom: 5px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .sub-tab {
            padding: 8px 16px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text);
            transition: all 0.2s;
        }
        .sub-tab:hover { border-color: #cbd5e1; }
        .sub-tab.active { background: #eff6ff; color: var(--primary); border-color: var(--primary); font-weight: 600; }
        .add-tab-btn {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        .add-tab-btn:hover { transform: scale(1.1); }

        /* --- PROFITABILITY VISUALIZER --- */
        .profit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        
        .profit-card { 
            background: white; 
            border: 1px solid var(--border); 
            border-radius: 16px; 
            padding: 20px; 
            display: flex; flex-direction: column;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .profit-card.dark-mode { background: #1e293b; color: white; border:none; }
        
        .profit-header { font-weight: 800; font-size: 1.1rem; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .profit-sub { font-size: 0.85rem; color: var(--text-light); margin-bottom: 15px; }
        .profit-card.dark-mode .profit-sub { color: #94a3b8; }

        .money-bar { 
            height: 36px; 
            display: flex; 
            width: 100%; 
            border-radius: 8px; 
            overflow: hidden; 
            margin: 10px 0 20px 0; 
            background: #f1f5f9;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .bar-segment { 
            height: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-size: 0.7rem; 
            font-weight: 700; 
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            overflow: hidden;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .legend-table { width: 100%; font-size: 0.9rem; }
        .legend-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--border); align-items: center; }
        .profit-card.dark-mode .legend-row { border-color: rgba(255,255,255,0.1); }
        
        .legend-label { display: flex; align-items: center; gap: 8px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        
        .final-row { margin-top: 10px; padding-top: 10px; border-top: 2px solid var(--border); font-weight: 800; font-size: 1.1rem; border-bottom: none; }
        .profit-card.dark-mode .final-row { border-color: rgba(255,255,255,0.2); }

        .bg-cost { background-color: var(--danger); } 
        .bg-margin { background-color: var(--success); } 
        .bg-comm { background-color: var(--warning); } 
        .bg-tva { background-color: var(--tva-color); } 

        /* Recipe Stats (Common) */
        .recipe-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px; }
        .stat-box { background:#f8fafc; padding:15px; border-radius:10px; border:1px solid var(--border); }
        .stat-label { margin-bottom:5px; font-weight:600; font-size: 0.8rem; color: var(--text-light); }
        .stat-value { font-size:1.2rem; font-weight:bold; color: var(--text); }

        /* Dashboard specific */
        .dashboard-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .dash-kpi { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 15px; text-align: center; }
        .dash-kpi-val { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        .dash-kpi-lbl { font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em;}

        .recipe-header { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .hidden { display: none; }
        .badge { padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .badge-auto { background: #dcfce7; color: #15803d; }
        .badge-manual { background: #fef9c3; color: #a16207; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); font-style: italic; background: #f8fafc; border-radius: 16px; border: 2px dashed var(--border); }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }

        /* Cloud Sync Styles */
        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            margin-left: 10px;
        }
        .sync-indicator.synced { color: #4ade80; }
        .sync-indicator.syncing { color: #fbbf24; }
        .sync-indicator.error { color: #f87171; }
        .sync-indicator.local { color: #94a3b8; }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        .sync-indicator.syncing .sync-dot {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .share-btn {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            border: none !important;
        }
        .share-btn:hover {
            background: linear-gradient(135deg, #059669, #047857) !important;
        }

        .share-modal-content {
            text-align: center;
        }
        .share-url-container {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .share-url-input {
            flex: 1;
            font-size: 0.85rem;
            background: #f1f5f9;
            border: 2px solid var(--border);
            padding: 12px;
            border-radius: 8px;
        }
        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .copy-btn:hover {
            background: var(--primary-dark);
        }
        .copy-btn.copied {
            background: var(--success);
        }

        .cloud-info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            font-size: 0.85rem;
            color: #1e40af;
        }
        .cloud-info i {
            margin-right: 8px;
        }

        .shared-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: 15px;
        }

        /* Cloud Sync Badge */
        .cloud-badge {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .cloud-badge:hover {
            transform: scale(1.05);
        }
        .cloud-badge.connected {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .cloud-badge.syncing {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        .cloud-badge .sync-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(20px); opacity: 0; }
        }

        /* Cloud Modal */
        .cloud-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .cloud-status.offline {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        .cloud-status.online {
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        .cloud-status i {
            font-size: 1.5rem;
        }
        .restaurant-code-input {
            font-size: 1.5rem !important;
            text-align: center;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: bold;
        }
        .cloud-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .cloud-actions .btn {
            flex: 1;
        }
        .last-sync {
            font-size: 0.75rem;
            color: var(--text-light);
            text-align: center;
            margin-top: 10px;
        }
        .cloud-users {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 10px;
        }
        .cloud-users i {
            color: var(--success);
        }

        /* Price History Styles */
        .price-history-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .price-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }
        .price-history-item:last-child {
            border-bottom: none;
        }
        .price-history-date {
            color: var(--text-light);
            font-size: 0.8rem;
        }
        .price-history-value {
            font-weight: 600;
        }
        .price-change-up {
            color: var(--danger);
        }
        .price-change-down {
            color: var(--success);
        }
        .price-change-indicator {
            font-size: 0.75rem;
            margin-left: 5px;
        }
        .ing-actions {
            display: flex;
            gap: 5px;
        }
        .ing-edit-btn {
            background: transparent;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .ing-edit-btn:hover {
            background: #eff6ff;
        }
        .history-badge {
            background: #fef3c7;
            color: #92400e;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }

        /* Margin Alerts Styles */
        .alert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--danger);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .alert-item:last-child {
            margin-bottom: 0;
        }
        .alert-item-name {
            font-weight: 600;
            color: var(--text);
        }
        .alert-item-details {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 3px;
        }
        .alert-item-margin {
            font-weight: 700;
            color: var(--danger);
            font-size: 1.1rem;
        }
        .alert-item-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 15px;
        }
        .alert-item-btn:hover {
            background: var(--primary-dark);
        }
        .sub-tab.alert-badge::after {
            content: '!';
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 0.65rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sub-tab {
            position: relative;
        }

    </style>
</head>
<body>

<header>
    <div class="header-content">
        <h1>
            <i class="fas fa-chart-pie"></i> FoodCost Pro
            <span id="cloudBadge" class="cloud-badge" onclick="openCloudModal()">
                <i class="fas fa-cloud" id="cloudIcon"></i> <span id="cloudStatus">Connexion</span>
            </span>
        </h1>
        <div class="header-actions">
            <button class="share-btn" onclick="openCloudModal()"><i class="fas fa-cloud"></i> Cloud</button>
            <button onclick="exportData()"><i class="fas fa-download"></i> Backup</button>
            <button onclick="document.getElementById('fileInput').click()"><i class="fas fa-upload"></i> Charger</button>
            <input type="file" id="fileInput" class="hidden" onchange="importData(this)">
            <button onclick="resetData()" style="background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.5);">Reset</button>
        </div>
    </div>
</header>

<!-- Mobile toggle button for ingredients -->
<button class="mobile-ing-toggle" id="mobileIngToggle" onclick="toggleMobileSidebar()">
    <i class="fas fa-carrot"></i>
</button>
<div class="mobile-sidebar-overlay" id="mobileSidebarOverlay" onclick="toggleMobileSidebar()"></div>

<div class="container">
    <aside id="ingredientsSidebar">
        <div class="card" style="height: fit-content; position: sticky; top: 20px;">
            <h2>
                Ingr√©dients
                <div>
                    <button class="btn btn-primary btn-sm" onclick="openIngredientModal()">+ Nouveau</button>
                    <button class="btn btn-outline btn-sm mobile-close-btn" onclick="toggleMobileSidebar()" style="display:none; margin-left:5px;"><i class="fas fa-times"></i></button>
                </div>
            </h2>
            <input type="text" id="searchIngredient" placeholder="üîç Rechercher..." oninput="renderIngredients()" style="margin-bottom: 15px;">
            <div class="ingredient-list" id="ingredientsList"></div>
        </div>
    </aside>

    <main>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchView('intermediate')" id="btn-view-int"><i class="fas fa-blender"></i> Pr√©parations</button>
            <button class="tab-btn" onclick="switchView('final')" id="btn-view-final"><i class="fas fa-utensils"></i> Plats</button>
            <button class="tab-btn" onclick="switchView('menus')" id="btn-view-menus"><i class="fas fa-book-open"></i> Menus</button>
        </div>

        <div id="view-intermediate">
            <div class="card">
                 <div class="sub-tabs-container" id="int-sub-tabs"></div>
                <div id="intermediateRecipeContent"></div>
            </div>
        </div>

        <div id="view-final" class="hidden">
            <div class="dashboard-row" id="globalDashboard">
                <div class="dash-kpi">
                    <div class="dash-kpi-val" id="dash-margin">--%</div>
                    <div class="dash-kpi-lbl">Marge Moyenne</div>
                </div>
                <div class="dash-kpi">
                    <div class="dash-kpi-val" id="dash-fc">--%</div>
                    <div class="dash-kpi-lbl">Food Cost Moyen</div>
                </div>
                <div class="dash-kpi">
                    <div class="dash-kpi-val text-success" id="dash-ok-count">0</div>
                    <div class="dash-kpi-lbl">Plats Rentables</div>
                    <div style="font-size:0.7rem; color:var(--text-light); margin-top:5px;">
                        Seuil: <input type="number" id="marginThreshold" value="70" min="0" max="100" style="width:50px; padding:2px 5px; font-size:0.75rem; border-radius:4px; border:1px solid var(--border);" onchange="updateMarginThreshold(this.value)">%
                    </div>
                </div>
            </div>
            <!-- Alertes de marge -->
            <div id="marginAlerts" class="card hidden" style="background: linear-gradient(135deg, #fef2f2, #fff7ed); border-color: #fecaca; margin-bottom: 20px;">
                <h2 style="color: var(--danger); margin-bottom: 15px;">
                    <i class="fas fa-exclamation-triangle"></i> Alertes de rentabilite
                </h2>
                <div id="alertsList"></div>
            </div>

            <!-- Graphique des marges -->
            <div class="card" style="margin-bottom: 20px;">
                <h2>
                    <span><i class="fas fa-chart-bar" style="color: var(--primary); margin-right: 8px;"></i> Visualisation des marges</span>
                    <button class="btn btn-outline btn-sm" onclick="toggleChartType()">
                        <i class="fas fa-exchange-alt"></i> Changer vue
                    </button>
                </h2>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="marginChart"></canvas>
                </div>
                <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 5px; font-size: 0.8rem;">
                        <span style="width: 12px; height: 12px; background: var(--success); border-radius: 3px;"></span>
                        <span>Marge ‚â• seuil</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px; font-size: 0.8rem;">
                        <span style="width: 12px; height: 12px; background: var(--warning); border-radius: 3px;"></span>
                        <span>Marge proche du seuil</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px; font-size: 0.8rem;">
                        <span style="width: 12px; height: 12px; background: var(--danger); border-radius: 3px;"></span>
                        <span>Marge < seuil</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="sub-tabs-container" id="fin-sub-tabs"></div>
               <div id="finalRecipeContent"></div>
           </div>
        </div>

        <div id="view-menus" class="hidden">
            <div class="card">
                <h2 style="margin-bottom: 20px;">
                    <i class="fas fa-book-open" style="color: var(--primary); margin-right: 10px;"></i>
                    Menus
                    <button class="btn btn-primary btn-sm" style="margin-left: auto;" onclick="createMenu()">
                        <i class="fas fa-plus"></i> Nouveau Menu
                    </button>
                </h2>
                <div id="menusContent">
                    <div class="empty-state">Aucun menu cr√©√©. Cr√©ez un menu pour combiner plusieurs plats.</div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- MODAL -->
<div id="ingredientModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000; backdrop-filter: blur(5px);">
    <div class="card" style="width: 400px; margin:0; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
        <h2 style="margin-bottom: 20px;">Ajouter Ingr√©dient</h2>
        <div class="form-group">
            <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block;">Nom</label>
            <input type="text" id="newIngName" placeholder="Ex: Tomates Cerises">
        </div>
        <div class="form-row">
            <div style="flex:1">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block;">Prix (‚Ç¨)</label>
                <input type="number" id="newIngPrice" step="0.01" placeholder="0.00">
            </div>
            <div style="flex:1">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block;">Pour</label>
                <select id="newIngUnit">
                    <option value="kg">1 kg</option>
                    <option value="g">1 g</option>
                    <option value="L">1 L</option>
                    <option value="ml">1 ml</option>
                    <option value="piece">1 pi√®ce</option>
                </select>
            </div>
        </div>
        <div class="flex-between" style="margin-top: 20px;">
            <button class="btn btn-danger" onclick="closeIngredientModal()">Annuler</button>
            <button class="btn btn-primary" onclick="saveNewIngredient()">Enregistrer</button>
        </div>
    </div>
</div>

<!-- SHARE MODAL -->
<div id="shareModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000; backdrop-filter: blur(5px);">
    <div class="card" style="width: 500px; max-width: 90%; margin:0; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
        <div class="share-modal-content">
            <h2 style="justify-content: center; margin-bottom: 10px;">
                <i class="fas fa-share-alt" style="color: var(--primary); margin-right: 10px;"></i>
                Partager vos recettes
            </h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Copiez ce lien pour partager vos recettes avec d'autres personnes.
            </p>

            <div id="shareLoading" style="padding: 30px; display: none;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary);"></i>
                <p style="margin-top: 10px; color: var(--text-light);">Creation du lien...</p>
            </div>

            <div id="shareResult" style="display: none;">
                <div class="share-url-container">
                    <input type="text" id="shareUrlInput" class="share-url-input" readonly>
                    <button class="copy-btn" onclick="copyShareUrl()">
                        <i class="fas fa-copy"></i> Copier
                    </button>
                </div>

                <div class="cloud-info">
                    <i class="fas fa-info-circle"></i>
                    Ce lien contient toutes vos donnees actuelles. Si vous modifiez vos recettes, regenerez un nouveau lien pour partager les modifications.
                </div>
            </div>

            <div id="shareError" style="display: none; color: var(--danger); padding: 20px;">
                <i class="fas fa-exclamation-triangle"></i>
                <p id="shareErrorMessage">Une erreur est survenue</p>
            </div>
        </div>

        <div class="flex-between" style="margin-top: 20px;">
            <button class="btn btn-outline" onclick="closeShareModal()">Fermer</button>
            <button class="btn btn-primary" onclick="shareData()" id="regenerateBtn">
                <i class="fas fa-sync"></i> Regenerer le lien
            </button>
        </div>
    </div>
</div>

<!-- EDIT INGREDIENT MODAL -->
<div id="editIngModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000; backdrop-filter: blur(5px);">
    <div class="card" style="width: 400px; margin:0; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
        <h2 style="margin-bottom: 20px;">
            <i class="fas fa-edit" style="color: var(--primary); margin-right: 10px;"></i>
            Modifier l'ingredient
        </h2>
        <div class="form-group">
            <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block;">Nom</label>
            <input type="text" id="editIngName" placeholder="Nom de l'ingredient">
        </div>
        <div class="form-row">
            <div style="flex:1">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block;">Prix (‚Ç¨)</label>
                <input type="number" id="editIngPrice" step="0.01" placeholder="0.00">
            </div>
            <div style="flex:1">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block;">Unite</label>
                <select id="editIngUnit">
                    <option value="kg">1 kg</option>
                    <option value="g">1 g</option>
                    <option value="L">1 L</option>
                    <option value="ml">1 ml</option>
                    <option value="piece">1 piece</option>
                </select>
            </div>
        </div>
        <input type="hidden" id="editIngId">
        <div class="flex-between" style="margin-top: 20px;">
            <button class="btn btn-outline" onclick="closeEditIngModal()">Annuler</button>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" onclick="showPriceHistory(document.getElementById('editIngId').value)">
                    <i class="fas fa-history"></i> Historique
                </button>
                <button class="btn btn-primary" onclick="saveEditIngredient()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<!-- PRICE HISTORY MODAL -->
<div id="priceHistoryModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1001; backdrop-filter: blur(5px);">
    <div class="card" style="width: 450px; max-width: 90%; margin:0; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
        <h2 style="margin-bottom: 20px;">
            <i class="fas fa-chart-line" style="color: var(--primary); margin-right: 10px;"></i>
            Historique des prix
        </h2>
        <p id="priceHistoryIngName" style="font-weight: 600; margin-bottom: 15px; color: var(--primary);"></p>
        <div id="priceHistoryContent" class="price-history-list"></div>
        <div class="flex-between" style="margin-top: 20px;">
            <button class="btn btn-outline" onclick="closePriceHistoryModal()">Fermer</button>
        </div>
    </div>
</div>

<!-- CLOUD SYNC MODAL -->
<div id="cloudModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1002; backdrop-filter: blur(5px);">
    <div class="card" style="width: 450px; max-width: 90%; margin:0; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
        <h2 style="margin-bottom: 20px; justify-content: center;">
            <i class="fas fa-cloud" style="color: var(--primary); margin-right: 10px;"></i>
            Synchronisation Cloud
        </h2>

        <div id="cloudStatusBox" class="cloud-status offline">
            <i class="fas fa-cloud-slash"></i>
            <div>
                <strong>Mode hors-ligne</strong>
                <div style="font-size: 0.85rem;">Entrez un code pour synchroniser</div>
            </div>
        </div>

        <div id="cloudConnectSection">
            <div id="firebaseSetupSection" style="display: none; margin-bottom: 15px; padding: 12px; background: #fef3c7; border-radius: 10px; font-size: 0.8rem;">
                <strong><i class="fas fa-info-circle"></i> Configuration Firebase requise</strong>
                <p style="margin: 8px 0;">Pour activer le cloud, vous devez creer un projet Firebase gratuit:</p>
                <ol style="margin-left: 20px; line-height: 1.6;">
                    <li>Allez sur <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a></li>
                    <li>Creez un nouveau projet</li>
                    <li>Activez "Realtime Database"</li>
                    <li>Copiez l'URL de la base</li>
                </ol>
                <div class="form-group" style="margin-top: 10px;">
                    <input type="text" id="firebaseUrlInput" placeholder="https://votre-projet.firebaseio.com" style="font-size: 0.8rem;">
                    <button class="btn btn-primary btn-sm" onclick="saveFirebaseUrl()" style="margin-top: 8px; width: 100%;">
                        <i class="fas fa-save"></i> Sauvegarder
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; display: block;">
                    <i class="fas fa-key"></i> Code Restaurant
                </label>
                <input type="text" id="restaurantCodeInput" class="restaurant-code-input" placeholder="EX: RESTO2024" maxlength="20">
                <p style="font-size: 0.75rem; color: var(--text-light); margin-top: 8px; text-align: center;">
                    Partagez ce code avec vos associes pour synchroniser les donnees
                </p>
            </div>

            <div class="cloud-actions">
                <button class="btn btn-primary" onclick="connectToCloud()">
                    <i class="fas fa-plug"></i> Connecter
                </button>
                <button class="btn btn-success" onclick="createNewCloud()">
                    <i class="fas fa-plus"></i> Creer nouveau
                </button>
            </div>

            <button class="btn btn-outline btn-sm" onclick="toggleFirebaseSetup()" style="width: 100%; margin-top: 15px;">
                <i class="fas fa-cog"></i> Configurer Firebase
            </button>
        </div>

        <div id="cloudConnectedSection" style="display: none;">
            <div style="text-align: center; padding: 10px 0;">
                <div style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 5px;">Code Restaurant</div>
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary); letter-spacing: 3px;" id="connectedCode">-</div>
            </div>

            <div class="cloud-users" id="cloudUsers">
                <i class="fas fa-users"></i>
                <span>Donn√©es partag√©es avec votre √©quipe</span>
            </div>

            <div class="last-sync" id="lastSyncTime">
                Derni√®re sync: --
            </div>

            <div class="cloud-actions" style="margin-top: 20px;">
                <button class="btn btn-outline" onclick="forceSync()">
                    <i class="fas fa-sync"></i> Sync maintenant
                </button>
                <button class="btn btn-danger" onclick="disconnectCloud()">
                    <i class="fas fa-sign-out-alt"></i> D√©connecter
                </button>
            </div>
        </div>

        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
            <button class="btn btn-outline" onclick="closeCloudModal()" style="width: 100%;">Fermer</button>
        </div>
    </div>
</div>

<script>
/* --- CONFIG STORAGE KEY --- */
const STORAGE_KEY = 'foodCostPro_v3_COMPLETE';
const CLOUD_CODE_KEY = 'foodCostPro_cloudCode';

/* --- FIREBASE CONFIG --- */
const FIREBASE_URL_KEY = 'foodCostPro_firebaseUrl';
const DEFAULT_FIREBASE_URL = 'https://encore-foodcost-default-rtdb.firebaseio.com';

function getFirebaseUrl() {
    return DEFAULT_FIREBASE_URL;
}

function toggleFirebaseSetup() {
    const section = document.getElementById('firebaseSetupSection');
    section.style.display = section.style.display === 'none' ? 'block' : 'none';

    // Pre-remplir avec l'URL existante
    const savedUrl = localStorage.getItem(FIREBASE_URL_KEY);
    if (savedUrl) {
        document.getElementById('firebaseUrlInput').value = savedUrl;
    }
}

function saveFirebaseUrl() {
    const url = document.getElementById('firebaseUrlInput').value.trim();
    if (!url || !url.includes('firebaseio.com') && !url.includes('firebasedatabase.app')) {
        alert('Veuillez entrer une URL Firebase valide');
        return;
    }

    localStorage.setItem(FIREBASE_URL_KEY, url);

    // Reinitialiser Firebase avec la nouvelle URL
    firebaseApp = null;
    firebaseDb = null;

    alert('URL Firebase sauvegardee! Vous pouvez maintenant vous connecter.');
    document.getElementById('firebaseSetupSection').style.display = 'none';
}

/* --- CLOUD SYNC VARIABLES --- */
let isCloudConnected = false;
let cloudCode = null;
let cloudPollInterval = null;
let lastSyncTime = null;
let syncInProgress = false;
let localVersion = 0;

/* --- CLOUD MODAL FUNCTIONS --- */
function openCloudModal() {
    document.getElementById('cloudModal').style.display = 'flex';
    updateCloudModalUI();
}

function closeCloudModal() {
    document.getElementById('cloudModal').style.display = 'none';
}

function updateCloudModalUI() {
    const statusBox = document.getElementById('cloudStatusBox');
    const connectSection = document.getElementById('cloudConnectSection');
    const connectedSection = document.getElementById('cloudConnectedSection');
    const badge = document.getElementById('cloudBadge');
    const badgeStatus = document.getElementById('cloudStatus');
    const badgeIcon = document.getElementById('cloudIcon');

    if (isCloudConnected && cloudCode) {
        // Mode connect√©
        statusBox.className = 'cloud-status online';
        statusBox.innerHTML = `
            <i class="fas fa-cloud-check"></i>
            <div>
                <strong>Connect√© au cloud</strong>
                <div style="font-size: 0.85rem;">Synchronisation automatique active</div>
            </div>
        `;
        connectSection.style.display = 'none';
        connectedSection.style.display = 'block';
        document.getElementById('connectedCode').textContent = cloudCode.toUpperCase();

        // Update badge
        badge.className = 'cloud-badge connected';
        badgeStatus.textContent = cloudCode.toUpperCase();
        badgeIcon.className = 'fas fa-cloud-check';

        // Update last sync time
        if (lastSyncTime) {
            document.getElementById('lastSyncTime').textContent =
                'Derni√®re sync: ' + new Date(lastSyncTime).toLocaleTimeString('fr-FR');
        }
    } else {
        // Mode d√©connect√©
        statusBox.className = 'cloud-status offline';
        statusBox.innerHTML = `
            <i class="fas fa-cloud-slash"></i>
            <div>
                <strong>Mode hors-ligne</strong>
                <div style="font-size: 0.85rem;">Entrez un code pour synchroniser</div>
            </div>
        `;
        connectSection.style.display = 'block';
        connectedSection.style.display = 'none';

        // Update badge
        badge.className = 'cloud-badge';
        badgeStatus.textContent = 'Connexion';
        badgeIcon.className = 'fas fa-cloud';
    }
}

function updateCloudBadgeSyncing(syncing) {
    const badge = document.getElementById('cloudBadge');
    const badgeIcon = document.getElementById('cloudIcon');

    if (syncing) {
        badge.classList.add('syncing');
        badgeIcon.className = 'fas fa-sync sync-spin';
    } else {
        badge.classList.remove('syncing');
        if (isCloudConnected) {
            badge.className = 'cloud-badge connected';
            badgeIcon.className = 'fas fa-cloud-check';
        }
    }
}

/* --- CLOUD CONNECTION (REST API) --- */
async function connectToCloud() {
    const codeInput = document.getElementById('restaurantCodeInput');
    const code = codeInput.value.trim().toUpperCase().replace(/[^A-Z0-9]/g, '');

    if (!code || code.length < 3) {
        alert('Veuillez entrer un code valide (minimum 3 caract√®res)');
        return;
    }

    updateCloudBadgeSyncing(true);
    console.log('Attempting to connect with code:', code);

    try {
        const baseUrl = getFirebaseUrl();
        const url = `${baseUrl}/restaurants/${code}.json`;
        console.log('Fetching:', url);

        const response = await fetch(url);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const cloudData = await response.json();
        console.log('Cloud data received:', cloudData);

        if (cloudData) {
            // Code existe, charger les donn√©es
            if (cloudData.data) {
                state = JSON.parse(cloudData.data);
                localVersion = cloudData.version || 0;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); // Sauvegarder en local sans trigger cloud
                renderAll();
                updateDashboard();
            }
            setupCloudConnection(code);
            alert('Connect√©! Donn√©es synchronis√©es depuis le cloud.');
        } else {
            alert('Code non trouv√©. Utilisez "Cr√©er nouveau" pour cr√©er un nouveau cloud.');
        }
    } catch (err) {
        console.error('Connect error:', err);
        alert('Erreur de connexion:\n\n' + err.message);
    }

    updateCloudBadgeSyncing(false);
}

async function createNewCloud() {
    const codeInput = document.getElementById('restaurantCodeInput');
    let code = codeInput.value.trim().toUpperCase().replace(/[^A-Z0-9]/g, '');

    if (!code || code.length < 3) {
        // G√©n√©rer un code al√©atoire
        code = 'R' + Math.random().toString(36).substring(2, 8).toUpperCase();
        codeInput.value = code;
    }

    updateCloudBadgeSyncing(true);
    console.log('Creating new cloud with code:', code);

    try {
        const baseUrl = getFirebaseUrl();

        // V√©rifier si le code existe d√©j√†
        console.log('Checking if code exists...');
        const checkResponse = await fetch(`${baseUrl}/restaurants/${code}.json`);
        const existingData = await checkResponse.json();

        if (existingData) {
            alert('Ce code existe d√©j√†! Choisissez un autre code ou utilisez "Connecter".');
            updateCloudBadgeSyncing(false);
            return;
        }

        // Cr√©er le nouveau cloud avec les donn√©es actuelles
        console.log('Creating new cloud entry...');
        localVersion = Date.now();
        const newData = {
            data: JSON.stringify(state),
            version: localVersion,
            createdAt: Date.now(),
            updatedAt: Date.now()
        };

        const response = await fetch(`${baseUrl}/restaurants/${code}.json`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newData)
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        console.log('Cloud created successfully');
        setupCloudConnection(code);
        alert('Cloud cr√©√©! Partagez le code "' + code + '" avec vos associ√©s.');
    } catch (err) {
        console.error('Create error:', err);
        alert('Erreur:\n\n' + err.message);
    }

    updateCloudBadgeSyncing(false);
}

function setupCloudConnection(code) {
    cloudCode = code;
    isCloudConnected = true;
    lastSyncTime = Date.now();

    // Sauvegarder le code en local
    localStorage.setItem(CLOUD_CODE_KEY, code);

    // Polling toutes les 10 secondes pour les changements
    if (cloudPollInterval) {
        clearInterval(cloudPollInterval);
    }

    cloudPollInterval = setInterval(async () => {
        if (syncInProgress || !isCloudConnected) return;

        try {
            const baseUrl = getFirebaseUrl();
            const response = await fetch(`${baseUrl}/restaurants/${cloudCode}.json`);
            const cloudData = await response.json();

            if (cloudData && cloudData.version > localVersion) {
                // Nouvelles donn√©es du cloud
                syncInProgress = true;
                state = JSON.parse(cloudData.data);
                localVersion = cloudData.version;
                lastSyncTime = Date.now();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                renderAll();
                updateDashboard();
                updateCloudModalUI();
                syncInProgress = false;

                // Notification discr√®te
                showSyncNotification('Donn√©es mises √† jour');
            }
        } catch (err) {
            console.error('Polling error:', err);
        }
    }, 10000); // Toutes les 10 secondes

    updateCloudModalUI();
}

function disconnectCloud() {
    if (confirm('D√©connecter du cloud? Les donn√©es locales seront conserv√©es.')) {
        if (cloudPollInterval) {
            clearInterval(cloudPollInterval);
            cloudPollInterval = null;
        }
        cloudCode = null;
        isCloudConnected = false;
        localStorage.removeItem(CLOUD_CODE_KEY);
        updateCloudModalUI();
    }
}

async function forceSync() {
    if (!isCloudConnected || !cloudCode) return;

    updateCloudBadgeSyncing(true);

    try {
        const baseUrl = getFirebaseUrl();
        const response = await fetch(`${baseUrl}/restaurants/${cloudCode}.json`);
        const cloudData = await response.json();

        if (cloudData && cloudData.data) {
            state = JSON.parse(cloudData.data);
            localVersion = cloudData.version || 0;
            lastSyncTime = Date.now();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            renderAll();
            updateDashboard();
            updateCloudModalUI();
            showSyncNotification('Synchronisation r√©ussie');
        }
    } catch (err) {
        console.error('Force sync error:', err);
        alert('Erreur de synchronisation: ' + err.message);
    }

    updateCloudBadgeSyncing(false);
}

async function saveToCloud() {
    if (!isCloudConnected || !cloudCode || syncInProgress) return;

    syncInProgress = true;
    updateCloudBadgeSyncing(true);

    try {
        const baseUrl = getFirebaseUrl();
        localVersion = Date.now();

        await fetch(`${baseUrl}/restaurants/${cloudCode}.json`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                data: JSON.stringify(state),
                version: localVersion,
                updatedAt: Date.now()
            })
        });
        lastSyncTime = Date.now();
    } catch (err) {
        console.error('Save to cloud error:', err);
    }

    syncInProgress = false;
    updateCloudBadgeSyncing(false);
}

function showSyncNotification(message) {
    // Cr√©er une notification discr√®te
    const notif = document.createElement('div');
    notif.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--success);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 0.85rem;
        font-weight: 600;
        z-index: 9999;
        animation: slideUp 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    `;
    notif.innerHTML = '<i class="fas fa-check-circle"></i> ' + message;
    document.body.appendChild(notif);

    setTimeout(() => {
        notif.style.animation = 'slideDown 0.3s ease';
        setTimeout(() => notif.remove(), 300);
    }, 2000);
}

/* --- AUTO-RECONNECT ON LOAD --- */
async function tryAutoReconnect() {
    const savedCode = localStorage.getItem(CLOUD_CODE_KEY);
    if (savedCode) {
        try {
            const baseUrl = getFirebaseUrl();
            const response = await fetch(`${baseUrl}/restaurants/${savedCode}.json`);
            const cloudData = await response.json();

            if (cloudData) {
                if (cloudData.data) {
                    state = JSON.parse(cloudData.data);
                    localVersion = cloudData.version || 0;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                    renderAll();
                    updateDashboard();
                }
                setupCloudConnection(savedCode);
            }
        } catch (err) {
            console.error('Auto-reconnect failed:', err);
            localStorage.removeItem(CLOUD_CODE_KEY);
        }
    }
}

/* --- URL SHARING (no server needed) --- */
let isSharedMode = false;

/* --- DONNEES INITIALES (COPIE DE TA LISTE) --- */
let state = { ingredients: [], intermediate: [], final: [], menus: [], priceHistory: {}, settings: { marginThreshold: 70 } };
let activeIntIndex = 0; let activeFinIndex = 0;

const initialData = {
    ingredients: [
        {id: 1, name: "Ail en Poudre", price: 10.70, unit: "kg"},
        {id: 2, name: "Ail frais", price: 4.94, unit: "kg"},
        {id: 3, name: "Ail Semoule", price: 11.17, unit: "kg"},
        {id: 4, name: "Basilic", price: 1.10, unit: "piece"},
        {id: 5, name: "Beurre", price: 11.03, unit: "kg"},
        {id: 6, name: "Blanc d'Oeuf", price: 6.33, unit: "kg"},
        {id: 7, name: "Buns", price: 0.50, unit: "piece"},
        {id: 8, name: "Cheddar", price: 0.11, unit: "piece"},
        {id: 9, name: "Cheddar Blanc", price: 0.11, unit: "piece"},
        {id: 10, name: "Chocolat Blanc", price: 14.21, unit: "kg"},
        {id: 11, name: "Coriandre Fraiche", price: 1.20, unit: "piece"},
        {id: 12, name: "Cornichon", price: 6.69, unit: "kg"},
        {id: 13, name: "Coulis de Chocolat", price: 6.57, unit: "kg"},
        {id: 14, name: "Cream Cheese", price: 9.48, unit: "kg"},
        {id: 15, name: "Cr√®me Liquide 35%mg", price: 4.86, unit: "L"},
        {id: 16, name: "Cr√®me Vanille", price: 6.96, unit: "kg"},
        {id: 17, name: "Croutons", price: 0.00, unit: "kg"},
        {id: 18, name: "Docello Pistache", price: 38.79, unit: "kg"},
        {id: 19, name: "Edamame", price: 3.59, unit: "kg"},
        {id: 20, name: "Extrait de Vanille Sebalc√©", price: 72.64, unit: "kg"},
        {id: 21, name: "Farine", price: 0.79, unit: "kg"},
        {id: 22, name: "Filet de B≈ìuf", price: 21.00, unit: "kg"},
        {id: 23, name: "G√©latine Bronze Bovine", price: 47.23, unit: "kg"},
        {id: 24, name: "Haut de cuisse Jacob", price: 6.47, unit: "kg"},
        {id: 25, name: "Huile d'Olive", price: 0.00, unit: "kg"},
        {id: 26, name: "Huile de Tournesol", price: 1.79, unit: "L"},
        {id: 27, name: "Huile de Truffe Blanche", price: 0.00, unit: "L"},
        {id: 28, name: "Huile de Truffe Noire", price: 62.00, unit: "L"},
        {id: 29, name: "Huile S√©same", price: 12.56, unit: "L"},
        {id: 30, name: "Jaune d'Oeuf", price: 6.42, unit: "kg"},
        {id: 31, name: "Jus de Citron Metro chef", price: 4.38, unit: "L"},
        {id: 32, name: "Jus de Veau Li√© M√©tro Chef", price: 16.04, unit: "kg"},
        {id: 33, name: "Jus de Yuzu Siracuse", price: 51.00, unit: "L"},
        {id: 34, name: "Ketchup", price: 3.61, unit: "kg"},
        {id: 35, name: "Lait Entier", price: 1.13, unit: "L"},
        {id: 36, name: "M&M's", price: 0.00, unit: "kg"},
        {id: 37, name: "Mayonnaise Citron", price: 2.81, unit: "kg"},
        {id: 38, name: "Merlan de B≈ìuf", price: 18.00, unit: "kg"},
        {id: 39, name: "Mini Piment Padron", price: 5.48, unit: "kg"},
        {id: 40, name: "Moutarde Dijon", price: 2.13, unit: "kg"},
        {id: 41, name: "Oignon C√©bette", price: 10.00, unit: "kg"},
        {id: 42, name: "Oignon en d√©s", price: 1.98, unit: "kg"},
        {id: 43, name: "Oignon Frit", price: 7.57, unit: "kg"},
        {id: 44, name: "Pain Bao", price: 0.54, unit: "piece"},
        {id: 45, name: "Paleron de Boeuf", price: 13.50, unit: "kg"},
        {id: 46, name: "Paprika Fum√©", price: 37.00, unit: "kg"},
        {id: 47, name: "Parmesan en Poudre", price: 23.30, unit: "kg"},
        {id: 48, name: "Pic en Bois", price: 0.01, unit: "piece"},
        {id: 49, name: "Pickles Oigon Rouge", price: 14.92, unit: "kg"},
        {id: 50, name: "Piment Chiliflakes", price: 16.10, unit: "kg"},
        {id: 51, name: "Piment d'Espelette", price: 111.00, unit: "kg"},
        {id: 52, name: "Piment Oiseaux", price: 30.08, unit: "kg"},
        {id: 53, name: "Piment Pilipili Moulu", price: 10.30, unit: "kg"},
        {id: 54, name: "Ponthier Mangue", price: 9.41, unit: "kg"},
        {id: 55, name: "Poudre d'Olive Sosa", price: 146.00, unit: "kg"},
        {id: 56, name: "Poudre de Gingembre", price: 22.50, unit: "kg"},
        {id: 57, name: "Pur√©e", price: 4.16, unit: "kg"},
        {id: 58, name: "Pur√©e de Gingembre", price: 14.64, unit: "kg"},
        {id: 59, name: "Pur√©e Lutosa", price: 3.30, unit: "kg"},
        {id: 60, name: "Riz au Lait", price: 5.36, unit: "kg"},
        {id: 61, name: "Riz Rond", price: 2.09, unit: "kg"},
        {id: 62, name: "Salade Iceberg", price: 2.00, unit: "kg"},
        {id: 63, name: "Salade Wakame", price: 11.69, unit: "kg"},
        {id: 64, name: "Sauce C√©sar", price: 0.00, unit: "L"},
        {id: 65, name: "Sauce Dynamite", price: 7.13, unit: "kg"},
        {id: 66, name: "Sauce Soja Sal√©", price: 8.91, unit: "L"},
        {id: 67, name: "Sauce Soja Sucr√©", price: 8.20, unit: "L"},
        {id: 68, name: "Sauce Sriracha", price: 6.63, unit: "kg"},
        {id: 69, name: "Sauce Tiger", price: 8.35, unit: "kg"},
        {id: 70, name: "Sauce Truffe", price: 17.57, unit: "kg"},
        {id: 71, name: "Sel Fin", price: 0.85, unit: "kg"},
        {id: 72, name: "Sosa Poudre Fum√©e", price: 0.00, unit: "kg"},
        {id: 73, name: "Sosa S√©same Noir Crispy", price: 0.00, unit: "kg"},
        {id: 74, name: "Steak Hach√© Metzger", price: 16.00, unit: "kg"},
        {id: 75, name: "Sucre", price: 6.29, unit: "kg"},
        {id: 76, name: "Tartipat Noisette Blanc", price: 0.00, unit: "kg"},
        {id: 77, name: "Tranche Piment Jalapeno", price: 0.02, unit: "piece"},
        {id: 78, name: "Viande √† Bao", price: 12.61, unit: "kg"},
        {id: 79, name: "Vinaigre de Cidre", price: 2.87, unit: "L"}
    ],
    priceHistory: {},
    settings: { marginThreshold: 70 },
    intermediate: [
        { id: 'INT_1', name: "Riz au Lait", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 61, quantity: 90, unit: 'g'}, {id: 75, quantity: 40, unit: 'g'}, {id: 10, quantity: 40, unit: 'g'}, {id: 20, quantity: 30, unit: 'g'}, {id: 15, quantity: 330, unit: 'ml'}, {id: 35, quantity: 500, unit: 'ml'}, {id: 71, quantity: 1, unit: 'g'}] },
        { id: 'INT_2', name: "Cr√®me Vanille", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 10, quantity: 2.5, unit: 'kg'}, {id: 20, quantity: 250, unit: 'g'}, {id: 35, quantity: 3, unit: 'L'}, {id: 15, quantity: 3, unit: 'L'}, {id: 23, quantity: 120, unit: 'g'}] },
        { id: 'INT_3', name: "Sauce Dynamite", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 68, quantity: 400, unit: 'g'}, {id: 14, quantity: 300, unit: 'g'}, {id: 40, quantity: 100, unit: 'g'}] },
        { id: 'INT_4', name: "Sauce Tiger", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 67, quantity: 4, unit: 'L'}, {id: 66, quantity: 750, unit: 'ml'}, {id: 58, quantity: 200, unit: 'g'}, {id: 2, quantity: 500, unit: 'g'}, {id: 11, quantity: 15, unit: 'piece'}, {id: 26, quantity: 4, unit: 'L'}, {id: 52, quantity: 100, unit: 'g'}, {id: 29, quantity: 1.5, unit: 'L'}] },
        { id: 'INT_5', name: "Sauce Yuzu", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 33, quantity: 100, unit: 'ml'}, {id: 14, quantity: 100, unit: 'g'}, {id: 28, quantity: 100, unit: 'ml'}, {id: 40, quantity: 50, unit: 'g'}] },
        { id: 'INT_6', name: "Pur√©e", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 59, quantity: 7.5, unit: 'kg'}, {id: 35, quantity: 4, unit: 'L'}, {id: 5, quantity: 3, unit: 'kg'}, {id: 71, quantity: 90, unit: 'g'}, {id: 72, quantity: 90, unit: 'g'}] },
        { id: 'INT_7', name: "Viande √† Bao", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 45, quantity: 10, unit: 'kg'}, {id: 32, quantity: 500, unit: 'g'}, {id: 46, quantity: 500, unit: 'g'}, {id: 'INT_4', quantity: 1, unit: 'L'}] },
        { id: 'INT_8', name: "Sauce C√©sar", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 40, quantity: 100, unit: 'g'}, {id: 25, quantity: 1, unit: 'L'}, {id: 47, quantity: 250, unit: 'g'}, {id: 2, quantity: 4, unit: 'g'}] },
        { id: 'INT_9', name: "Mayonnaise Citron", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 30, quantity: 200, unit: 'g'}, {id: 40, quantity: 100, unit: 'g'}, {id: 26, quantity: 1, unit: 'L'}, {id: 31, quantity: 300, unit: 'ml'}, {id: 71, quantity: 50, unit: 'g'}] }
    ],
    final: [
        { id: 'FIN_1', name: "Dynamite Burger", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 7, quantity: 1, unit: 'piece'}, {id: 74, quantity: 120, unit: 'g'}, {id: 8, quantity: 3, unit: 'piece'}, {id: 'INT_3', quantity: 40, unit: 'g'}, {id: 39, quantity: 10, unit: 'g'}, {id: 49, quantity: 10, unit: 'g'}, {id: 41, quantity: 5, unit: 'g'}] },
        { id: 'FIN_2', name: "Tiger Burger", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 7, quantity: 1, unit: 'piece'}, {id: 74, quantity: 120, unit: 'g'}, {id: 8, quantity: 3, unit: 'piece'}, {id: 'INT_4', quantity: 40, unit: 'g'}, {id: 68, quantity: 5, unit: 'g'}, {id: 43, quantity: 5, unit: 'g'}] },
        { id: 'FIN_3', name: "Yuzu Burger", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 7, quantity: 1, unit: 'piece'}, {id: 74, quantity: 120, unit: 'g'}, {id: 9, quantity: 3, unit: 'piece'}, {id: 70, quantity: 40, unit: 'g'}, {id: 62, quantity: 20, unit: 'g'}, {id: 12, quantity: 10, unit: 'g'}] },
        { id: 'FIN_4', name: "Classic", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 7, quantity: 1, unit: 'piece'}, {id: 74, quantity: 120, unit: 'g'}, {id: 8, quantity: 3, unit: 'piece'}, {id: 34, quantity: 10, unit: 'g'}, {id: 40, quantity: 5, unit: 'g'}, {id: 42, quantity: 5, unit: 'g'}, {id: 12, quantity: 10, unit: 'g'}] },
        { id: 'FIN_5', name: "Boeuf Tiger", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 22, quantity: 150, unit: 'g'}, {id: 48, quantity: 1, unit: 'piece'}, {id: 'INT_4', quantity: 20, unit: 'g'}, {id: 68, quantity: 5, unit: 'g'}, {id: 43, quantity: 5, unit: 'g'}, {id: 41, quantity: 5, unit: 'g'}] },
        { id: 'FIN_6', name: "Pur√©e (Plat)", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 'INT_6', quantity: 200, unit: 'g'}, {id: 'INT_4', quantity: 20, unit: 'g'}] },
        { id: 'FIN_7', name: "Bao", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 44, quantity: 1, unit: 'piece'}, {id: 'INT_7', quantity: 15, unit: 'g'}, {id: 'INT_4', quantity: 5, unit: 'g'}, {id: 43, quantity: 10, unit: 'g'}, {id: 49, quantity: 5, unit: 'g'}, {id: 41, quantity: 5, unit: 'g'}, {id: 68, quantity: 5, unit: 'g'}] },
        { id: 'FIN_8', name: "Wrap Salad", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 62, quantity: 200, unit: 'g'}, {id: 14, quantity: 40, unit: 'g'}, {id: 'INT_9', quantity: 20, unit: 'g'}, {id: 43, quantity: 10, unit: 'g'}, {id: 19, quantity: 60, unit: 'g'}, {id: 47, quantity: 25, unit: 'g'}, {id: 55, quantity: 1, unit: 'g'}, {id: 50, quantity: 2, unit: 'g'}] }
    ]
};

/* --- INIT --- */
window.onload = function() {
    // Check for shared data in URL first
    const urlParams = new URLSearchParams(window.location.search);
    const sharedData = urlParams.get('data');

    if (sharedData) {
        // Decompress and load shared data from URL
        try {
            const decompressed = LZString.decompressFromEncodedURIComponent(sharedData);
            if (decompressed) {
                state = JSON.parse(decompressed);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } else {
                loadData();
            }
        } catch (err) {
            console.error('Error loading shared data:', err);
            loadData();
        }
    } else {
        loadData();
    }

    updateDashboard();
    renderAll();

    // Essayer de se reconnecter au cloud automatiquement
    setTimeout(() => {
        tryAutoReconnect();
    }, 500);
};

/* --- CLOUD SYNC FUNCTIONS --- */
function updateSyncIndicator(status) {
    const indicator = document.getElementById('syncIndicator');
    if (!indicator) return;

    indicator.className = 'sync-indicator ' + status;

    switch(status) {
        case 'synced':
            indicator.innerHTML = '<span class="sync-dot"></span> Synchronise';
            break;
        case 'syncing':
            indicator.innerHTML = '<span class="sync-dot"></span> Synchronisation...';
            break;
        case 'error':
            indicator.innerHTML = '<span class="sync-dot"></span> Erreur';
            break;
        case 'local':
        default:
            indicator.innerHTML = '<span class="sync-dot"></span> Local';
            break;
    }
}

function showSharedBadge() {
    const badge = document.getElementById('sharedBadge');
    if (badge) {
        badge.classList.remove('hidden');
    }
}

function hideSharedBadge() {
    const badge = document.getElementById('sharedBadge');
    if (badge) {
        badge.classList.add('hidden');
    }
}

function generateShareUrl() {
    // Compress state data and create URL
    const jsonStr = JSON.stringify(state);
    const compressed = LZString.compressToEncodedURIComponent(jsonStr);
    return `${window.location.origin}${window.location.pathname}?data=${compressed}`;
}

/* --- SHARE MODAL FUNCTIONS --- */
function openShareModal() {
    document.getElementById('shareModal').style.display = "flex";
}

function closeShareModal() {
    document.getElementById('shareModal').style.display = "none";
}

function shareData() {
    openShareModal();

    const loadingEl = document.getElementById('shareLoading');
    const resultEl = document.getElementById('shareResult');
    const errorEl = document.getElementById('shareError');

    // Reset modal state
    loadingEl.style.display = 'none';
    resultEl.style.display = 'none';
    errorEl.style.display = 'none';

    try {
        // Generate share URL with compressed data
        const shareUrl = generateShareUrl();

        // Check URL length (most browsers support ~8000 chars)
        if (shareUrl.length > 8000) {
            errorEl.style.display = 'block';
            document.getElementById('shareErrorMessage').textContent =
                'Vos donnees sont trop volumineuses pour etre partagees par lien (' +
                Math.round(shareUrl.length/1000) + 'KB). Utilisez le bouton "Sauvegarder" pour exporter un fichier JSON.';
            return;
        }

        document.getElementById('shareUrlInput').value = shareUrl;
        resultEl.style.display = 'block';

        // Update UI
        isSharedMode = true;
        showSharedBadge();
        updateSyncIndicator('synced');

    } catch (err) {
        errorEl.style.display = 'block';
        document.getElementById('shareErrorMessage').textContent = 'Erreur: ' + err.message;
    }
}

function copyShareUrl() {
    const input = document.getElementById('shareUrlInput');
    input.select();
    input.setSelectionRange(0, 99999);

    navigator.clipboard.writeText(input.value).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.classList.add('copied');
        btn.innerHTML = '<i class="fas fa-check"></i> Copie!';

        setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = '<i class="fas fa-copy"></i> Copier';
        }, 2000);
    });
}

function disconnectCloud() {
    if (confirm('Retourner en mode local? Le lien de partage ne sera plus valide.')) {
        isSharedMode = false;
        hideSharedBadge();
        updateSyncIndicator('local');

        // Remove share parameter from URL
        window.history.replaceState({}, '', window.location.pathname);

        closeShareModal();
    }
}

function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    updateDashboard();

    // Synchroniser avec le cloud si connect√©
    if (isCloudConnected) {
        saveToCloud();
    }
}

function loadData() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) state = JSON.parse(saved);
    else state = JSON.parse(JSON.stringify(initialData));
}

function resetData() {
    if(confirm("Tout effacer et recharger la carte par defaut ?")) {
        localStorage.removeItem(STORAGE_KEY);
        state = JSON.parse(JSON.stringify(initialData));
        activeIntIndex = 0; activeFinIndex = 0;
        isSharedMode = false;
        hideSharedBadge();
        updateSyncIndicator('local');
        window.history.replaceState({}, '', window.location.pathname);
        renderAll();
    }
}

function exportData() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
    const node = document.createElement('a');
    node.setAttribute("href", dataStr);
    node.setAttribute("download", "mes_recettes.json");
    document.body.appendChild(node);
    node.click();
    node.remove();
}

function importData(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            state = JSON.parse(e.target.result);
            activeIntIndex = 0; activeFinIndex = 0;
            saveData(); renderAll();
        } catch(err) { console.error("Erreur.", err); }
    };
    reader.readAsText(file);
}

function renderAll() {
    renderIngredients();
    renderIntermediateRecipes();
    renderFinalRecipes();
    renderMenus();
}

function switchView(view) {
    document.getElementById('view-intermediate').classList.add('hidden');
    document.getElementById('view-final').classList.add('hidden');
    document.getElementById('view-menus').classList.add('hidden');
    document.getElementById('btn-view-int').classList.remove('active');
    document.getElementById('btn-view-final').classList.remove('active');
    document.getElementById('btn-view-menus').classList.remove('active');
    document.getElementById('view-' + view).classList.remove('hidden');
    if (view === 'intermediate') document.getElementById('btn-view-int').classList.add('active');
    else if (view === 'final') document.getElementById('btn-view-final').classList.add('active');
    else if (view === 'menus') document.getElementById('btn-view-menus').classList.add('active');
    if(view === 'final') updateDashboard();
    if(view === 'menus') renderMenus();
}

function switchSubTab(type, index) {
    if (type === 'intermediate') { activeIntIndex = index; renderIntermediateRecipes(); } 
    else { activeFinIndex = index; renderFinalRecipes(); }
}

/* --- SECURE DELETE --- */
function checkUsage(id) {
    for (let r of state.intermediate) { if (r.items.some(i => i.id == id)) return `Utilis√© dans la pr√©paration: "${r.name}"`; }
    for (let r of state.final) { if (r.items.some(i => i.id == id)) return `Utilis√© dans le plat: "${r.name}"`; }
    return null;
}

function deleteIngredient(id) {
    const usage = checkUsage(id);
    if(usage) { alert("Impossible de supprimer cet ingr√©dient.\n" + usage); return; }
    if(confirm("Supprimer cet ingr√©dient ?")) {
        state.ingredients = state.ingredients.filter(i => i.id !== id);
        saveData(); renderAll();
    }
}

function deleteRec(type, index) {
    const recipe = state[type][index];
    if (type === 'intermediate') {
        const usage = checkUsage(recipe.id);
        if(usage) { alert("Impossible de supprimer cette pr√©paration.\n" + usage); return; }
    }
    if(confirm(`Supprimer "${recipe.name}" ?`)) {
        state[type].splice(index, 1);
        if (type === 'intermediate') { activeIntIndex = Math.max(0, Math.min(activeIntIndex, state.intermediate.length - 1)); renderIntermediateRecipes(); } 
        else { activeFinIndex = Math.max(0, Math.min(activeFinIndex, state.final.length - 1)); renderFinalRecipes(); }
        saveData();
    }
}

/* --- CALCULS --- */
function normalizeUnit(val, unit) {
    if (unit === 'kg' || unit === 'L') return val * 1000;
    if (unit === 'cl') return val * 10;
    if (unit === 'dl') return val * 100;
    return val; 
}

function calculateCost(items, visitedIds = new Set()) {
    let total = 0;
    items.forEach(item => {
        let component = state.ingredients.find(i => i.id == item.id);
        let isInter = false;
        if (!component) { component = state.intermediate.find(r => r.id == item.id); isInter = true; }
        
        if (component) {
            if (isInter && visitedIds.has(component.id)) return; 
            let pricePerUnit = 0;
            if (isInter) {
                const nextVisited = new Set(visitedIds);
                nextVisited.add(component.id);
                const subTotal = calculateCost(component.items, nextVisited);
                const yieldVal = normalizeUnit(component.yield, component.yieldUnit);
                pricePerUnit = yieldVal > 0 ? subTotal / yieldVal : 0;
            } else {
                if (component.unit === 'kg' || component.unit === 'L') pricePerUnit = component.price / 1000;
                else if (component.unit === 'g' || component.unit === 'ml') pricePerUnit = component.price; 
                else if (component.unit === 'cl') pricePerUnit = component.price / 10;
                else pricePerUnit = component.price; 
            }
            let qty = item.quantity;
            if (item.unit === 'kg' || item.unit === 'L') qty *= 1000;
            if (item.unit === 'cl') qty *= 10;
            if (item.unit === 'dl') qty *= 100;
            total += qty * pricePerUnit;
        }
    });
    return total;
}

function calculateTheoreticalWeight(items) {
    let total = 0;
    items.forEach(item => {
        if (item.unit === 'piece') return;
        let qty = item.quantity;
        if (item.unit === 'kg' || item.unit === 'L') qty *= 1000;
        if (item.unit === 'cl') qty *= 10;
        if (item.unit === 'dl') qty *= 100;
        total += qty;
    });
    return total;
}

function updateDashboard() {
    // Recuperer le seuil de marge
    const threshold = state.settings?.marginThreshold ?? 70;
    const thresholdInput = document.getElementById('marginThreshold');
    if (thresholdInput) thresholdInput.value = threshold;

    let totalHT = 0; let totalCost = 0; let profitableCount = 0;
    const alerts = [];

    state.final.forEach((r, idx) => {
        const cost = calculateCost(r.items);
        const vatRate = parseFloat(r.vat) || 0;
        const priceHT = (parseFloat(r.sellingPrice) || 0) / (1 + (vatRate/100));
        if (priceHT > 0) {
            totalHT += priceHT; totalCost += cost;
            const margin = ((priceHT - cost) / priceHT) * 100;
            const fc = (cost / priceHT) * 100;
            if (margin >= threshold) {
                profitableCount++;
            } else {
                // Ajouter aux alertes
                alerts.push({
                    index: idx,
                    name: r.name,
                    margin: margin,
                    fc: fc,
                    cost: cost,
                    priceHT: priceHT,
                    priceTTC: r.sellingPrice
                });
            }
        }
    });

    const avgMargin = totalHT > 0 ? ((totalHT - totalCost) / totalHT) * 100 : 0;
    const avgFc = totalHT > 0 ? (totalCost / totalHT) * 100 : 0;
    const elMargin = document.getElementById('dash-margin');
    const elFc = document.getElementById('dash-fc');
    const elCount = document.getElementById('dash-ok-count');
    if(elMargin) {
        elMargin.innerText = avgMargin.toFixed(1) + '%';
        elMargin.className = "dash-kpi-val " + (avgMargin >= threshold ? "text-success" : (avgMargin < threshold - 10 ? "text-danger" : "text-warning"));
    }
    if(elFc) elFc.innerText = avgFc.toFixed(1) + '%';
    if(elCount) elCount.innerText = profitableCount + " / " + state.final.length;

    // Afficher les alertes
    updateMarginAlerts(alerts, threshold);

    // Mettre a jour le graphique
    updateMarginChart();
}

function updateMarginThreshold(value) {
    const threshold = parseInt(value) || 70;
    if (!state.settings) state.settings = {};
    state.settings.marginThreshold = threshold;
    saveData();
    updateDashboard();
}

function updateMarginAlerts(alerts, threshold) {
    const alertsContainer = document.getElementById('marginAlerts');
    const alertsList = document.getElementById('alertsList');

    if (!alertsContainer || !alertsList) return;

    if (alerts.length === 0) {
        alertsContainer.classList.add('hidden');
        return;
    }

    alertsContainer.classList.remove('hidden');

    // Trier par marge (plus basse en premier)
    alerts.sort((a, b) => a.margin - b.margin);

    alertsList.innerHTML = alerts.map(alert => `
        <div class="alert-item">
            <div>
                <div class="alert-item-name">${alert.name}</div>
                <div class="alert-item-details">
                    Cout: ${alert.cost.toFixed(2)}‚Ç¨ | Prix HT: ${alert.priceHT.toFixed(2)}‚Ç¨ | FC: ${alert.fc.toFixed(1)}%
                </div>
            </div>
            <div style="display:flex; align-items:center;">
                <div class="alert-item-margin">${alert.margin.toFixed(1)}%</div>
                <button class="alert-item-btn" onclick="activeFinIndex=${alert.index}; renderFinalRecipes();">
                    <i class="fas fa-arrow-right"></i> Voir
                </button>
            </div>
        </div>
    `).join('');
}

/* --- MARGIN CHART FUNCTIONS --- */
let marginChart = null;
let currentChartType = 'bar';

function updateMarginChart() {
    const canvas = document.getElementById('marginChart');
    if (!canvas) return;

    const threshold = state.settings?.marginThreshold ?? 70;

    // Preparer les donnees
    const chartData = state.final.map(r => {
        const cost = calculateCost(r.items);
        const vatRate = parseFloat(r.vat) || 0;
        const priceHT = (parseFloat(r.sellingPrice) || 0) / (1 + (vatRate/100));
        const margin = priceHT > 0 ? ((priceHT - cost) / priceHT) * 100 : 0;
        return { name: r.name, margin: margin };
    });

    // Trier par marge (du plus bas au plus haut)
    chartData.sort((a, b) => a.margin - b.margin);

    const labels = chartData.map(d => d.name.length > 15 ? d.name.substring(0, 15) + '...' : d.name);
    const margins = chartData.map(d => d.margin);
    const colors = chartData.map(d => {
        if (d.margin >= threshold) return '#10b981'; // success
        if (d.margin >= threshold - 10) return '#f59e0b'; // warning
        return '#ef4444'; // danger
    });

    // Detruire le graphique existant s'il existe
    if (marginChart) {
        marginChart.destroy();
    }

    const ctx = canvas.getContext('2d');

    if (currentChartType === 'bar') {
        marginChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Marge (%)',
                    data: margins,
                    backgroundColor: colors,
                    borderColor: colors,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Marge: ' + context.raw.toFixed(1) + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: { color: '#e2e8f0' },
                        ticks: {
                            callback: function(value) { return value + '%'; }
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                // Ligne de seuil
                annotation: {
                    annotations: {
                        thresholdLine: {
                            type: 'line',
                            yMin: threshold,
                            yMax: threshold,
                            borderColor: '#64748b',
                            borderWidth: 2,
                            borderDash: [5, 5]
                        }
                    }
                }
            }
        });
    } else {
        // Graphique en donut - repartition des plats
        const aboveThreshold = chartData.filter(d => d.margin >= threshold).length;
        const nearThreshold = chartData.filter(d => d.margin >= threshold - 10 && d.margin < threshold).length;
        const belowThreshold = chartData.filter(d => d.margin < threshold - 10).length;

        marginChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Rentables (‚â•' + threshold + '%)', 'Proches du seuil', 'Non rentables'],
                datasets: [{
                    data: [aboveThreshold, nearThreshold, belowThreshold],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 20, usePointStyle: true }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percent = total > 0 ? ((context.raw / total) * 100).toFixed(1) : 0;
                                return context.label + ': ' + context.raw + ' plat(s) (' + percent + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
}

function toggleChartType() {
    currentChartType = currentChartType === 'bar' ? 'doughnut' : 'bar';
    updateMarginChart();
}

function renderIngredients() {
    const list = document.getElementById('ingredientsList');
    const search = document.getElementById('searchIngredient').value.toLowerCase();
    list.innerHTML = '';
    state.ingredients.sort((a, b) => a.name.localeCompare(b.name)).filter(i => i.name.toLowerCase().includes(search)).forEach(ing => {
        const div = document.createElement('div');
        div.className = 'ing-item';
        const historyCount = getHistoryCount(ing.id);
        const historyBadge = historyCount > 0 ? `<span class="history-badge" title="${historyCount} modification(s)">${historyCount}</span>` : '';
        div.innerHTML = `
            <div class="ing-details">
                <span class="ing-name">${ing.name}${historyBadge}</span>
                <span class="ing-price">${ing.price.toFixed(2)} ‚Ç¨ / ${ing.unit}</span>
            </div>
            <div class="ing-actions">
                <button class="ing-edit-btn" onclick="openEditIngModal(${ing.id})" title="Modifier"><i class="fas fa-pencil-alt"></i></button>
                <button class="btn btn-outline btn-sm" style="color:var(--danger); border-color:transparent" onclick="deleteIngredient(${ing.id})"><i class="fas fa-trash"></i></button>
            </div>`;
        list.appendChild(div);
    });
}

function openIngredientModal() { document.getElementById('ingredientModal').style.display = "flex"; }
function closeIngredientModal() { document.getElementById('ingredientModal').style.display = "none"; }

/* --- MOBILE SIDEBAR TOGGLE --- */
function toggleMobileSidebar() {
    const sidebar = document.getElementById('ingredientsSidebar');
    const overlay = document.getElementById('mobileSidebarOverlay');
    const toggleBtn = document.getElementById('mobileIngToggle');

    if (sidebar.classList.contains('mobile-show')) {
        sidebar.classList.remove('mobile-show');
        overlay.classList.remove('show');
        toggleBtn.classList.remove('active');
        toggleBtn.innerHTML = '<i class="fas fa-carrot"></i>';
        document.body.style.overflow = '';
    } else {
        sidebar.classList.add('mobile-show');
        overlay.classList.add('show');
        toggleBtn.classList.add('active');
        toggleBtn.innerHTML = '<i class="fas fa-times"></i>';
        document.body.style.overflow = 'hidden';
    }
}

/* --- EDIT INGREDIENT FUNCTIONS --- */
function openEditIngModal(id) {
    const ing = state.ingredients.find(i => i.id === id);
    if (!ing) return;
    document.getElementById('editIngId').value = id;
    document.getElementById('editIngName').value = ing.name;
    document.getElementById('editIngPrice').value = ing.price;
    document.getElementById('editIngUnit').value = ing.unit;
    document.getElementById('editIngModal').style.display = "flex";
}

function closeEditIngModal() {
    document.getElementById('editIngModal').style.display = "none";
}

function saveEditIngredient() {
    const id = parseInt(document.getElementById('editIngId').value);
    const name = document.getElementById('editIngName').value;
    const newPrice = parseFloat(document.getElementById('editIngPrice').value);
    const unit = document.getElementById('editIngUnit').value;

    const ing = state.ingredients.find(i => i.id === id);
    if (!ing || !name || isNaN(newPrice)) return;

    // Enregistrer l'historique si le prix a change
    if (ing.price !== newPrice) {
        recordPriceChange(id, ing.price, newPrice);
    }

    // Mettre a jour l'ingredient
    ing.name = name;
    ing.price = newPrice;
    ing.unit = unit;

    saveData();
    renderAll();
    closeEditIngModal();
}

/* --- PRICE HISTORY FUNCTIONS --- */
function recordPriceChange(ingredientId, oldPrice, newPrice) {
    if (!state.priceHistory) {
        state.priceHistory = {};
    }
    if (!state.priceHistory[ingredientId]) {
        state.priceHistory[ingredientId] = [];
    }

    state.priceHistory[ingredientId].push({
        date: new Date().toISOString(),
        oldPrice: oldPrice,
        newPrice: newPrice
    });
}

function showPriceHistory(ingredientId) {
    const id = parseInt(ingredientId);
    const ing = state.ingredients.find(i => i.id === id);
    if (!ing) return;

    document.getElementById('priceHistoryIngName').textContent = ing.name + ' (' + ing.price.toFixed(2) + ' ‚Ç¨ / ' + ing.unit + ')';

    const history = state.priceHistory && state.priceHistory[id] ? state.priceHistory[id] : [];
    const contentEl = document.getElementById('priceHistoryContent');

    if (history.length === 0) {
        contentEl.innerHTML = '<div style="text-align:center; padding:30px; color:var(--text-light);"><i class="fas fa-history" style="font-size:2rem; margin-bottom:10px; opacity:0.3;"></i><p>Aucun historique de prix</p><p style="font-size:0.8rem;">Les modifications de prix seront enregistrees ici.</p></div>';
    } else {
        // Afficher du plus recent au plus ancien
        const sortedHistory = [...history].reverse();
        contentEl.innerHTML = sortedHistory.map((entry, idx) => {
            const date = new Date(entry.date);
            const formattedDate = date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
            const change = entry.newPrice - entry.oldPrice;
            const changePercent = entry.oldPrice > 0 ? ((change / entry.oldPrice) * 100).toFixed(1) : 0;
            const isUp = change > 0;

            return `
                <div class="price-history-item">
                    <div>
                        <div class="price-history-date">${formattedDate}</div>
                        <div style="font-size:0.8rem; color:var(--text-light);">
                            ${entry.oldPrice.toFixed(2)} ‚Ç¨ ‚Üí ${entry.newPrice.toFixed(2)} ‚Ç¨
                        </div>
                    </div>
                    <div class="price-history-value ${isUp ? 'price-change-up' : 'price-change-down'}">
                        ${isUp ? '+' : ''}${change.toFixed(2)} ‚Ç¨
                        <span class="price-change-indicator">(${isUp ? '+' : ''}${changePercent}%)</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    document.getElementById('priceHistoryModal').style.display = "flex";
}

function closePriceHistoryModal() {
    document.getElementById('priceHistoryModal').style.display = "none";
}

function getHistoryCount(ingredientId) {
    if (!state.priceHistory || !state.priceHistory[ingredientId]) return 0;
    return state.priceHistory[ingredientId].length;
}

function saveNewIngredient() {
    const name = document.getElementById('newIngName').value;
    const price = parseFloat(document.getElementById('newIngPrice').value);
    const unit = document.getElementById('newIngUnit').value;
    if(name && !isNaN(price)) {
        state.ingredients.push({ id: Date.now(), name, price, unit });
        saveData(); renderAll(); closeIngredientModal();
    }
}

function getIngredientSelectOptions(currentId, excludeRecipeId) {
    let html = '<option value="">Choisir...</option>';
    const sortedIng = [...state.ingredients].sort((a,b) => a.name.localeCompare(b.name));
    html += '<optgroup label="Ingr√©dients">';
    sortedIng.forEach(ing => { html += `<option value="${ing.id}" ${ing.id == currentId ? 'selected' : ''}>${ing.name}</option>`; });
    html += '</optgroup>';
    if (state.intermediate.length > 0) {
        const sortedInter = [...state.intermediate].sort((a,b) => a.name.localeCompare(b.name));
        html += '<optgroup label="Pr√©parations">';
        sortedInter.forEach(rec => { if (rec.id !== excludeRecipeId) { html += `<option value="${rec.id}" ${rec.id == currentId ? 'selected' : ''}>${rec.name}</option>`; } });
        html += '</optgroup>';
    }
    return html;
}

function updateRecipeCalculations(type, index) {
    const recipe = state[type][index];
    const cost = calculateCost(recipe.items, new Set([recipe.id])); 
    
    if (type === 'intermediate') {
        const theoreticalWeight = calculateTheoreticalWeight(recipe.items);
        if(recipe.manualYield) {
           const currentYield = normalizeUnit(recipe.yield, recipe.yieldUnit);
           if(theoreticalWeight > 0) { recipe.lossPercent = Math.max(0, (1 - (currentYield / theoreticalWeight)) * 100); }
        } else {
            const loss = parseFloat(recipe.lossPercent) || 0;
            const newYield = theoreticalWeight * (1 - (loss/100));
            if(recipe.yieldUnit === 'kg' || recipe.yieldUnit === 'L') recipe.yield = newYield / 1000;
            else if (recipe.yieldUnit === 'cl') recipe.yield = newYield / 10;
            else recipe.yield = newYield;
        }
        const yieldG = normalizeUnit(recipe.yield, recipe.yieldUnit);
        const pricePerKg = yieldG > 0 ? (cost / yieldG) * 1000 : 0;
        const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
        setTxt(`int-cost-${index}`, cost.toFixed(2) + ' ‚Ç¨');
        const elWeight = document.getElementById(`int-theo-weight-${index}`);
        if(elWeight) elWeight.innerHTML = `<strong>${theoreticalWeight.toFixed(0)} g</strong>`;
        setTxt(`int-pricekg-${index}`, pricePerKg.toFixed(2) + ' ‚Ç¨ / kg');
        const elBadge = document.getElementById(`int-badge-${index}`);
        if(elBadge) elBadge.innerHTML = recipe.manualYield ? '<span class="badge badge-manual">Manuel</span>' : '<span class="badge badge-auto">Auto</span>';
        setVal(`int-loss-input-${index}`, (recipe.lossPercent || 0).toFixed(1));
        if(!recipe.manualYield) setVal(`int-yield-input-${index}`, parseFloat(recipe.yield).toFixed(2));

    } else if (type === 'final') {
        // UPDATE ONLY DOM ELEMENTS, DO NOT RE-RENDER WHOLE VIEW
        const vatRate = parseFloat(recipe.vat) || 0;
        
        // 1. Update Table Costs
        recipe.items.forEach((item, itemIdx) => {
            const cell = document.getElementById(`fin-item-cost-${itemIdx}`);
            if(cell) cell.innerText = calculateCost([item]).toFixed(2) + ' ‚Ç¨';
        });

        // Emballage (commun aux deux)
        const packagingCost = parseFloat(recipe.packagingCost) || 0;
        const totalCost = cost + packagingCost;

        // 2. Update Calculations (Emporter / Sur Place) - avec emballage
        const priceTTC = parseFloat(recipe.sellingPrice) || 0;
        const priceHT = priceTTC / (1 + (vatRate/100));
        const tvaAmount = priceTTC - priceHT;
        const marginVal = priceHT - totalCost;
        const foodCostPercent = priceHT > 0 ? (totalCost / priceHT) * 100 : 0;

        const wTva = priceTTC > 0 ? (tvaAmount / priceTTC) * 100 : 0;
        const wCost = priceTTC > 0 ? (totalCost / priceTTC) * 100 : 0;
        const wMargin = priceTTC > 0 ? (marginVal / priceTTC) * 100 : 0;

        // 3. Update Calculations (Livraison) - Prix calcul√© depuis Emporter + frais plateforme
        // Pour avoir le m√™me FC%, le prix livraison doit compenser les frais de plateforme
        const commPercent = parseFloat(recipe.commission) || 30;
        const deliveryFee = parseFloat(recipe.deliveryFee) || 0;
        const serviceFee = parseFloat(recipe.serviceFee) || 0;

        // Calcul auto du prix livraison pour avoir m√™me marge nette que emporter:
        // delivPriceHT - (delivPriceHT * comm%) - fees = priceHT
        // delivPriceHT * (1 - comm%) = priceHT + fees
        // delivPriceHT = (priceHT + fees) / (1 - comm%)
        const calculatedDelivPriceHT = (priceHT + deliveryFee + serviceFee) / (1 - commPercent / 100);
        const calculatedDelivPriceTTC = calculatedDelivPriceHT * (1 + (vatRate / 100));

        // Mettre √† jour le prix de livraison automatiquement
        if (recipe.deliveryPrice !== calculatedDelivPriceTTC.toFixed(2)) {
            recipe.deliveryPrice = calculatedDelivPriceTTC.toFixed(2);
            saveData();
        }

        const delivPriceTTC = parseFloat(recipe.deliveryPrice) || calculatedDelivPriceTTC;
        const delivPriceHT = delivPriceTTC / (1 + (vatRate/100));
        const delivTva = delivPriceTTC - delivPriceHT;
        const commAmount = delivPriceHT * (commPercent / 100);
        const totalPlatformFees = commAmount + deliveryFee + serviceFee;
        const delivMarginVal = delivPriceHT - totalCost - totalPlatformFees;
        // Le FC% livraison = m√™me que emporter car on re√ßoit le m√™me montant net
        const delivFoodCostPercent = foodCostPercent;

        const dwTva = delivPriceTTC > 0 ? (delivTva / delivPriceTTC) * 100 : 0;
        const dwComm = delivPriceTTC > 0 ? (totalPlatformFees / delivPriceTTC) * 100 : 0;
        const dwCost = delivPriceTTC > 0 ? (totalCost / delivPriceTTC) * 100 : 0;
        const dwMargin = delivPriceTTC > 0 ? (delivMarginVal / delivPriceTTC) * 100 : 0;

        // 4. Update DOM Elements (Sur Place)
        const setStyle = (id, width) => { const el = document.getElementById(id); if(el) el.style.width = Math.max(0, width) + '%'; };
        const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
        const setHtml = (id, val) => { const el = document.getElementById(id); if(el) el.innerHTML = val; };

        setStyle('bar-sp-tva', wTva);
        setStyle('bar-sp-cost', wCost);
        setStyle('bar-sp-margin', wMargin);

        setTxt('val-sp-tva', tvaAmount.toFixed(2) + ' ‚Ç¨');
        setHtml('val-sp-cost', `${totalCost.toFixed(2)} ‚Ç¨ <span style="font-size:0.75rem;opacity:0.7">(Mat: ${cost.toFixed(2)}‚Ç¨ + Emb: ${packagingCost.toFixed(2)}‚Ç¨)</span>`);
        setTxt('val-sp-margin', marginVal.toFixed(2) + ' ‚Ç¨');

        // Afficher le FC% pour emporter
        const fcSpEl = document.getElementById('val-sp-fc');
        if(fcSpEl) {
            fcSpEl.innerText = foodCostPercent.toFixed(0) + '%';
            fcSpEl.style.color = foodCostPercent > 35 ? 'var(--danger)' : 'var(--success)';
        }

        const rowSp = document.getElementById('row-sp-margin');
        if(rowSp) rowSp.style.color = foodCostPercent > 35 ? 'var(--danger)' : 'var(--success)';

        // 5. Update DOM Elements (Livraison)
        setStyle('bar-liv-tva', dwTva);
        setStyle('bar-liv-comm', dwComm);
        setStyle('bar-liv-cost', dwCost);
        setStyle('bar-liv-margin', dwMargin);

        setTxt('val-liv-price', delivPriceTTC.toFixed(2) + ' ‚Ç¨');
        setTxt('val-liv-tva', delivTva.toFixed(2) + ' ‚Ç¨');
        setHtml('val-liv-comm', `${totalPlatformFees.toFixed(2)} ‚Ç¨ <span style="font-size:0.7rem;opacity:0.8">(${commPercent}%: ${commAmount.toFixed(2)}‚Ç¨${deliveryFee > 0 ? ' + Liv: ' + deliveryFee.toFixed(2) + '‚Ç¨' : ''}${serviceFee > 0 ? ' + Serv: ' + serviceFee.toFixed(2) + '‚Ç¨' : ''})</span>`);
        setHtml('val-liv-cost', `${totalCost.toFixed(2)} ‚Ç¨ <span style="font-size:0.75rem;opacity:0.7">(Mat: ${cost.toFixed(2)}‚Ç¨ + Emb: ${packagingCost.toFixed(2)}‚Ç¨)</span>`);
        setTxt('val-liv-margin', delivMarginVal.toFixed(2) + ' ‚Ç¨');

        // Afficher le FC% pour livraison
        const fcLivEl = document.getElementById('val-liv-fc');
        if(fcLivEl) {
            fcLivEl.innerText = delivFoodCostPercent.toFixed(0) + '%';
            fcLivEl.style.color = delivFoodCostPercent > 35 ? '#f87171' : '#4ade80';
        }

        const rowLiv = document.getElementById('row-liv-margin');
        if(rowLiv) rowLiv.style.color = delivFoodCostPercent > 35 ? '#f87171' : '#4ade80';
    }
}

function renderIntermediateRecipes() {
    const tabContainer = document.getElementById('int-sub-tabs');
    const contentContainer = document.getElementById('intermediateRecipeContent');
    const addBtn = document.createElement('button');
    addBtn.className = 'add-tab-btn'; addBtn.innerHTML = '+'; addBtn.onclick = createIntermediateRecipe;
    addBtn.title = "Nouvelle pr√©paration";
    tabContainer.innerHTML = '';
    if(state.intermediate.length === 0) {
        tabContainer.appendChild(addBtn);
        contentContainer.innerHTML = `<div class="empty-state">Aucune pr√©paration. Cr√©ez vos sauces ou bases ici.</div>`;
        return;
    }
    state.intermediate.forEach((recipe, i) => {
        const tab = document.createElement('button');
        tab.className = `sub-tab ${i === activeIntIndex ? 'active' : ''}`;
        tab.innerText = recipe.name;
        tab.onclick = () => switchSubTab('intermediate', i);
        tabContainer.appendChild(tab);
    });
    tabContainer.appendChild(addBtn);
    if(activeIntIndex >= state.intermediate.length) activeIntIndex = state.intermediate.length - 1;
    const recipe = state.intermediate[activeIntIndex];
    const index = activeIntIndex;
    if(recipe.lossPercent === undefined) recipe.lossPercent = 0;

    contentContainer.innerHTML = `
        <div style="padding-top:10px;">
             <div class="recipe-header">
                <input type="text" value="${recipe.name}" oninput="updateRecName('intermediate', ${index}, this.value)" style="font-weight:bold; font-size:1.3rem; width:auto; flex:1; padding:10px;">
                <button class="btn btn-outline" onclick="duplicateRecipe('intermediate', ${index})" title="Dupliquer cette pr√©paration"><i class="fas fa-copy"></i></button>
                <button class="btn btn-danger" onclick="deleteRec('intermediate', ${index})"><i class="fas fa-trash"></i></button>
            </div>
            <table>
                <thead><tr><th>Ingr√©dient</th><th style="width:100px">Qt√©</th><th style="width:80px">Unit√©</th><th style="width:80px">Co√ªt</th><th></th></tr></thead>
                <tbody>
                    ${recipe.items.map((item, itemIdx) => `
                        <tr>
                            <td><select onchange="updateRecItem('intermediate', ${index}, ${itemIdx}, 'id', this.value)">${getIngredientSelectOptions(item.id, recipe.id)}</select></td>
                            <td><input type="number" step="0.1" value="${item.quantity}" oninput="updateRecItem('intermediate', ${index}, ${itemIdx}, 'quantity', this.value)"></td>
                            <td><select onchange="updateRecItem('intermediate', ${index}, ${itemIdx}, 'unit', this.value)">
                                <option value="g" ${item.unit==='g'?'selected':''}>g</option><option value="ml" ${item.unit==='ml'?'selected':''}>ml</option><option value="cl" ${item.unit==='cl'?'selected':''}>cl</option><option value="kg" ${item.unit==='kg'?'selected':''}>kg</option><option value="L" ${item.unit==='L'?'selected':''}>L</option>
                            </select></td>
                            <td style="color:var(--text-light); font-weight:600;">${calculateCost([item], new Set([recipe.id])).toFixed(2)} ‚Ç¨</td>
                            <td><button class="btn btn-outline btn-sm" style="color:var(--danger);border:none" onclick="removeRecItem('intermediate', ${index}, ${itemIdx})">‚úï</button></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div class="flex-between" style="margin-bottom:15px;">
                <button class="btn btn-sm btn-primary" onclick="addRecItem('intermediate', ${index})">+ Ingr√©dient</button>
                <div style="font-size:0.85rem; color:var(--text-light);">Poids th√©orique: <span id="int-theo-weight-${index}">...</span></div>
            </div>
            <div class="recipe-stats" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                <div class="stat-box">
                    <div class="stat-label">Co√ªt Total</div>
                    <div class="stat-value" id="int-cost-${index}">...</div>
                </div>
                <div class="stat-box">
                    <div class="flex-between" style="margin-bottom:5px;">
                        <span class="stat-label">Rendement & Perte</span>
                        <span id="int-badge-${index}"></span>
                    </div>
                    <div class="form-row" style="margin-bottom:0">
                         <div style="flex:1"><label style="font-size:0.7rem;">% Perte</label><input type="number" id="int-loss-input-${index}" oninput="updateRecField('intermediate', ${index}, 'lossPercent', this.value)"></div>
                        <div style="flex:1"><label style="font-size:0.7rem;">Poids Final</label><input type="number" id="int-yield-input-${index}" oninput="setManualYield(${index}); updateRecField('intermediate', ${index}, 'yield', this.value)"></div>
                         <div style="width:60px"><label style="font-size:0.7rem;">Unit√©</label><select onchange="updateRecField('intermediate', ${index}, 'yieldUnit', this.value)"><option value="g" ${recipe.yieldUnit==='g'?'selected':''}>g</option><option value="kg" ${recipe.yieldUnit==='kg'?'selected':''}>kg</option><option value="L" ${recipe.yieldUnit==='L'?'selected':''}>L</option><option value="ml" ${recipe.yieldUnit==='ml'?'selected':''}>ml</option></select></div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Co√ªt de revient</div>
                    <div class="stat-value" style="color:var(--primary)" id="int-pricekg-${index}">...</div>
                </div>
            </div>
        </div>
    `;
    updateRecipeCalculations('intermediate', index);
}

function renderFinalRecipes() {
    const tabContainer = document.getElementById('fin-sub-tabs');
    const contentContainer = document.getElementById('finalRecipeContent');
    const addBtn = document.createElement('button');
    addBtn.className = 'add-tab-btn'; addBtn.innerHTML = '+'; addBtn.onclick = createFinalRecipe;
    addBtn.title = "Nouveau plat";
    tabContainer.innerHTML = '';
    if(state.final.length === 0) {
        tabContainer.appendChild(addBtn);
        contentContainer.innerHTML = `<div class="empty-state">Aucun plat. Cliquez sur + pour commencer.</div>`;
        return;
    }
    state.final.forEach((recipe, i) => {
        const tab = document.createElement('button');
        tab.className = `sub-tab ${i === activeFinIndex ? 'active' : ''}`;
        tab.innerText = recipe.name;
        tab.onclick = () => switchSubTab('final', i);
        tabContainer.appendChild(tab);
    });
    tabContainer.appendChild(addBtn);
    if(activeFinIndex >= state.final.length) activeFinIndex = state.final.length - 1;
    const recipe = state.final[activeFinIndex];
    const index = activeFinIndex;

    // --- CALCULS POUR AFFICHAGE INITIAL ---
    // Note: These are just placeholders, the actual values are populated via updateRecipeCalculations
    // to ensure logic is centralized. However, we need initial structure with IDs.
    
    contentContainer.innerHTML = `
        <div style="padding-top:10px;">
            <div class="recipe-header">
                <input type="text" value="${recipe.name}" oninput="updateRecName('final', ${index}, this.value)" style="font-weight:bold; font-size:1.3rem; color:var(--primary-dark); width:auto; flex:1; padding:10px;">
                <button class="btn btn-outline" onclick="duplicateRecipe('final', ${index})" title="Dupliquer ce plat"><i class="fas fa-copy"></i></button>
                <button class="btn btn-danger" onclick="deleteRec('final', ${index})"><i class="fas fa-trash"></i></button>
            </div>

            <div style="margin-bottom: 30px;">
                <table>
                    <thead><tr><th>Composant</th><th>Qt√©</th><th>Unit√©</th><th>Co√ªt</th><th></th></tr></thead>
                    <tbody>
                        ${recipe.items.map((item, itemIdx) => `
                            <tr>
                                <td><select onchange="updateRecItem('final', ${index}, ${itemIdx}, 'id', this.value)">${getIngredientSelectOptions(item.id, null)}</select></td>
                                <td><input type="number" step="0.1" value="${item.quantity}" oninput="updateRecItem('final', ${index}, ${itemIdx}, 'quantity', this.value)"></td>
                                <td><select onchange="updateRecItem('final', ${index}, ${itemIdx}, 'unit', this.value)">
                                    <option value="g" ${item.unit==='g'?'selected':''}>g</option><option value="piece" ${item.unit==='piece'?'selected':''}>pce</option><option value="ml" ${item.unit==='ml'?'selected':''}>ml</option><option value="cl" ${item.unit==='cl'?'selected':''}>cl</option><option value="dl" ${item.unit==='dl'?'selected':''}>dl</option><option value="kg" ${item.unit==='kg'?'selected':''}>kg</option><option value="L" ${item.unit==='L'?'selected':''}>L</option>
                                </select></td>
                                <td id="fin-item-cost-${itemIdx}" style="font-size:0.85rem; color:var(--text-light); font-weight:600;">-- ‚Ç¨</td>
                                <td><button class="btn btn-outline btn-sm" style="color:var(--danger); border:none" onclick="removeRecItem('final', ${index}, ${itemIdx})">‚úï</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <button class="btn btn-sm btn-primary" onclick="addRecItem('final', ${index})">+ Composant</button>
            </div>

            <div class="form-row" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-weight: 600;"><i class="fas fa-box"></i> Emballage :</span>
                    <input type="number" step="0.01" value="${recipe.packagingCost || 0}" oninput="updateRecField('final', ${index}, 'packagingCost', this.value)" style="width: 70px; font-weight: bold;"> ‚Ç¨
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-weight: 600;">TVA :</span>
                    <input type="number" value="${recipe.vat}" oninput="updateRecField('final', ${index}, 'vat', this.value)" style="width: 60px; font-weight: bold;"> %
                </div>
            </div>

            <div class="profit-grid">
                <!-- CARD EMPORTER -->
                <div class="profit-card">
                    <div class="profit-header">
                        <div style="display:flex; align-items:center; gap:8px;"><i class="fas fa-shopping-bag" style="color:var(--primary);"></i> Emporter</div>
                    </div>
                    <div class="form-row" style="margin-bottom:15px;">
                        <div style="flex:1;">
                            <label style="font-size:0.7rem; font-weight:700; text-transform:uppercase; color:var(--text-light);">Prix TTC</label>
                            <input type="number" step="0.1" value="${recipe.sellingPrice}" oninput="updateRecField('final', ${index}, 'sellingPrice', this.value)" style="font-size:1.3rem; font-weight:800; color:var(--text); padding:8px; width:100%;">
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:0.7rem; font-weight:700; text-transform:uppercase; color:var(--text-light);">Cible FC %</label>
                            <input type="number" style="font-size:1.3rem; font-weight:800; padding:8px; width:100%; border:2px solid var(--primary);" placeholder="%" onchange="updatePriceFromFC('final', ${index}, this.value, false)">
                        </div>
                        <div style="flex:1; text-align:center;">
                            <label style="font-size:0.7rem; font-weight:700; text-transform:uppercase; color:var(--text-light);">Food Cost</label>
                            <div id="val-sp-fc" style="font-size:1.3rem; font-weight:800; padding:8px; color:var(--primary);">--%</div>
                        </div>
                    </div>

                    <div class="money-bar">
                        <div id="bar-sp-tva" class="bar-segment bg-tva" style="width:0%" title="TVA">TVA</div>
                        <div id="bar-sp-cost" class="bar-segment bg-cost" style="width:0%" title="Co√ªt">Co√ªt</div>
                        <div id="bar-sp-margin" class="bar-segment bg-margin" style="width:0%" title="Marge">Marge</div>
                    </div>

                    <div class="legend-table">
                        <div class="legend-row"><div class="legend-label"><span class="dot bg-tva"></span> Part √âtat (TVA)</div> <span id="val-sp-tva">-- ‚Ç¨</span></div>
                        <div class="legend-row"><div class="legend-label"><span class="dot bg-cost"></span> Co√ªt Total</div> <span id="val-sp-cost">-- ‚Ç¨</span></div>
                        <div class="legend-row final-row" id="row-sp-margin">
                            <div class="legend-label"><span class="dot bg-margin"></span> Reste pour vous</div>
                            <span id="val-sp-margin">-- ‚Ç¨</span>
                        </div>
                    </div>
                </div>

                <!-- CARD LIVRAISON -->
                <div class="profit-card dark-mode">
                    <div class="profit-header">
                        <div style="display:flex; align-items:center; gap:8px;"><i class="fas fa-motorcycle" style="color:#38bdf8;"></i> Livraison (Plateforme)</div>
                    </div>
                    <div class="form-row" style="margin-bottom:8px;">
                        <div style="flex:1.5;">
                            <label style="font-size:0.65rem; font-weight:700; text-transform:uppercase; color:#94a3b8;">Prix TTC (auto)</label>
                            <div id="val-liv-price" style="font-size:1.3rem; font-weight:800; padding:6px; color:#38bdf8;">${recipe.deliveryPrice || '--'} ‚Ç¨</div>
                        </div>
                        <div style="flex:1; text-align:center;">
                            <label style="font-size:0.65rem; font-weight:700; text-transform:uppercase; color:#94a3b8;">Food Cost</label>
                            <div id="val-liv-fc" style="font-size:1.3rem; font-weight:800; padding:6px; color:#38bdf8;">--%</div>
                        </div>
                    </div>
                    <div class="form-row" style="margin-bottom:10px;">
                        <div style="flex:1;">
                            <label style="font-size:0.6rem; font-weight:600; text-transform:uppercase; color:#94a3b8;">Comm %</label>
                            <input type="number" value="${recipe.commission || 30}" oninput="updateRecField('final', ${index}, 'commission', this.value)" style="background:rgba(255,255,255,0.1); color:white; border:none; font-size:0.95rem; font-weight:bold; width:100%; padding:6px;">
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:0.6rem; font-weight:600; text-transform:uppercase; color:#94a3b8;">Frais Liv ‚Ç¨</label>
                            <input type="number" step="0.1" value="${recipe.deliveryFee || 0}" oninput="updateRecField('final', ${index}, 'deliveryFee', this.value)" style="background:rgba(255,255,255,0.1); color:white; border:none; font-size:0.95rem; font-weight:bold; width:100%; padding:6px;">
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:0.6rem; font-weight:600; text-transform:uppercase; color:#94a3b8;">Frais Serv ‚Ç¨</label>
                            <input type="number" step="0.1" value="${recipe.serviceFee || 0}" oninput="updateRecField('final', ${index}, 'serviceFee', this.value)" style="background:rgba(255,255,255,0.1); color:white; border:none; font-size:0.95rem; font-weight:bold; width:100%; padding:6px;">
                        </div>
                    </div>

                    <div class="money-bar" style="opacity:0.9;">
                        <div id="bar-liv-tva" class="bar-segment bg-tva" style="width:0%" title="TVA"></div>
                        <div id="bar-liv-comm" class="bar-segment bg-comm" style="width:0%" title="Commission">Comm.</div>
                        <div id="bar-liv-cost" class="bar-segment bg-cost" style="width:0%" title="Co√ªt">Co√ªt</div>
                        <div id="bar-liv-margin" class="bar-segment bg-margin" style="width:0%" title="Marge"></div>
                    </div>

                    <div class="legend-table">
                        <div class="legend-row"><div class="legend-label"><span class="dot bg-tva"></span> Part √âtat (TVA)</div> <span id="val-liv-tva">-- ‚Ç¨</span></div>
                        <div class="legend-row"><div class="legend-label"><span class="dot bg-comm"></span> Part Plateforme</div> <span id="val-liv-comm">-- ‚Ç¨</span></div>
                        <div class="legend-row"><div class="legend-label"><span class="dot bg-cost"></span> Co√ªt Total</div> <span id="val-liv-cost">-- ‚Ç¨</span></div>
                        <div class="legend-row final-row" id="row-liv-margin">
                            <div class="legend-label"><span class="dot bg-margin"></span> Reste pour vous</div>
                            <span id="val-liv-margin">-- ‚Ç¨</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    // Initial calculation update to fill values
    updateRecipeCalculations('final', index);
}

function createIntermediateRecipe() {
    state.intermediate.push({ id: 'INT_' + Date.now(), name: "Nouvelle Recette", yield: 0, yieldUnit: 'g', items: [], manualYield: false, lossPercent: 0 });
    activeIntIndex = state.intermediate.length - 1;
    saveData(); renderIntermediateRecipes();
}

function createFinalRecipe() {
    state.final.push({
        id: 'FIN_' + Date.now(),
        name: "Nouveau Plat",
        sellingPrice: 15.00,
        deliveryPrice: 18.00,
        vat: 10,
        commission: 30,
        deliveryFee: 0,
        serviceFee: 0,
        packagingCost: 0.50,
        items: []
    });
    activeFinIndex = state.final.length - 1;
    saveData(); renderFinalRecipes();
}

/* --- GENERIC HELPERS --- */
function addRecItem(type, index) {
    state[type][index].items.push({id: '', quantity: 1, unit: 'g'});
    saveData();
    if(type === 'intermediate') renderIntermediateRecipes(); else renderFinalRecipes();
}

function removeRecItem(type, recIndex, itemIndex) {
    state[type][recIndex].items.splice(itemIndex, 1);
    saveData();
    if(type === 'intermediate') renderIntermediateRecipes(); else renderFinalRecipes();
}

function updateRecName(type, index, val) {
    state[type][index].name = val; saveData();
    // Headers are re-rendered, so we might lose focus if editing name directly in a non-isolated way.
    // But here the name input is part of the full render.
    // For name update, we usually accept losing focus or use a different strategy. 
    // Given the request was about numbers/prices, this is acceptable or we can apply same ID fix.
    // Ideally name input should have an ID and be updated without re-render too.
    // But let's stick to the requested fix for now.
}

function updateRecField(type, index, field, val) {
    state[type][index][field] = parseFloat(val) || val;
    if (type === 'intermediate') {
        if(field === 'lossPercent') { state[type][index].manualYield = false; } 
    }
    saveData();
    updateRecipeCalculations(type, index); 
}

function updateRecItem(type, recIdx, itemIdx, field, val) {
    if (field === 'id') val = val.startsWith('INT_') ? val : parseInt(val);
    else if (field === 'quantity') val = parseFloat(val);
    state[type][recIdx].items[itemIdx][field] = val;
    saveData();
    updateRecipeCalculations(type, recIdx);
}

function updatePriceFromFC(type, index, targetFC, isDelivery) {
    const recipe = state[type][index];
    const cost = calculateCost(recipe.items, new Set([recipe.id]));
    const vatRate = parseFloat(recipe.vat) || 0;
    const target = parseFloat(targetFC);
    const packagingCost = parseFloat(recipe.packagingCost) || 0;

    if (target > 0 && cost > 0) {
        if (isDelivery) {
            // Pour livraison: commission% + frais fixes (livraison + service)
            // Food Cost % = totalCost / (Prix HT - Commission - FraisLiv - FraisServ)
            // priceHTNet = totalCost / (target% / 100)
            // priceHT * (1 - comm%/100) - delivFee - servFee = priceHTNet
            // priceHT = (priceHTNet + delivFee + servFee) / (1 - comm%/100)
            const commPercent = parseFloat(recipe.commission) || 30;
            const deliveryFee = parseFloat(recipe.deliveryFee) || 0;
            const serviceFee = parseFloat(recipe.serviceFee) || 0;
            const totalCost = cost + packagingCost;
            const priceHTNet = totalCost / (target / 100);
            const priceHT = (priceHTNet + deliveryFee + serviceFee) / (1 - commPercent / 100);
            const priceTTC = priceHT * (1 + (vatRate / 100));
            recipe.deliveryPrice = priceTTC.toFixed(2);
        } else {
            // Pour emporter: avec emballage
            const totalCost = cost + packagingCost;
            const priceHT = totalCost / (target / 100);
            const priceTTC = priceHT * (1 + (vatRate / 100));
            recipe.sellingPrice = priceTTC.toFixed(2);
        }
        saveData();
        renderFinalRecipes();
    }
}

function setManualYield(index) {
    state.intermediate[index].manualYield = true;
    saveData();
    document.getElementById(`int-badge-${index}`).innerHTML = '<span class="badge badge-manual">Manuel</span>';
}

/* --- DUPLICATION DE RECETTES --- */
function duplicateRecipe(type, index) {
    const original = state[type][index];
    // Deep copy de la recette
    const copy = JSON.parse(JSON.stringify(original));

    // Nouveau ID unique
    if (type === 'intermediate') {
        copy.id = 'INT_' + Date.now();
    } else {
        copy.id = 'FIN_' + Date.now();
    }

    // Ajouter "(copie)" au nom
    copy.name = original.name + ' (copie)';

    // Ajouter la copie √† la liste
    state[type].push(copy);

    // S√©lectionner la nouvelle recette
    if (type === 'intermediate') {
        activeIntIndex = state.intermediate.length - 1;
        saveData();
        renderIntermediateRecipes();
    } else {
        activeFinIndex = state.final.length - 1;
        saveData();
        renderFinalRecipes();
        updateDashboard();
    }
}

/* --- GESTION DES MENUS --- */
let activeMenuIndex = 0;

function createMenu() {
    if (!state.menus) state.menus = [];
    state.menus.push({
        id: 'MENU_' + Date.now(),
        name: 'Nouveau Menu',
        sellingPrice: 25.00,
        deliveryPrice: 30.00,
        vat: 10,
        commission: 30,
        deliveryFee: 0,
        serviceFee: 0,
        packagingCost: 1.00,
        dishes: []
    });
    activeMenuIndex = state.menus.length - 1;
    saveData();
    renderMenus();
}

function renderMenus() {
    const container = document.getElementById('menusContent');
    if (!container) return;
    if (!state.menus) state.menus = [];

    if (state.menus.length === 0) {
        container.innerHTML = '<div class="empty-state">Aucun menu cr√©√©. Cr√©ez un menu pour combiner plusieurs plats.</div>';
        return;
    }

    let html = '';
    state.menus.forEach((menu, index) => {
        const menuCost = calculateMenuCost(menu);
        const vatRate = parseFloat(menu.vat) || 10;
        const packagingCost = parseFloat(menu.packagingCost) || 0;
        const totalCost = menuCost + packagingCost;

        // Calculs Emporter
        const priceTTC = parseFloat(menu.sellingPrice) || 0;
        const priceHT = priceTTC / (1 + (vatRate / 100));
        const tvaAmount = priceTTC - priceHT;
        const marginSP = priceHT - totalCost;
        const fcSP = priceHT > 0 ? (totalCost / priceHT) * 100 : 0;

        // Calculs Livraison - Prix auto-calcul√© depuis Emporter + frais plateforme
        const commPercent = parseFloat(menu.commission) || 30;
        const deliveryFee = parseFloat(menu.deliveryFee) || 0;
        const serviceFee = parseFloat(menu.serviceFee) || 0;

        // Prix livraison = Prix emporter + frais plateforme pour garder m√™me marge
        const calculatedDelivPriceHT = (priceHT + deliveryFee + serviceFee) / (1 - commPercent / 100);
        const calculatedDelivPriceTTC = calculatedDelivPriceHT * (1 + (vatRate / 100));

        const delivPriceTTC = calculatedDelivPriceTTC;
        const delivPriceHT = calculatedDelivPriceHT;
        const delivTva = delivPriceTTC - delivPriceHT;
        const commAmount = delivPriceHT * (commPercent / 100);
        const totalPlatformFees = commAmount + deliveryFee + serviceFee;
        const marginDeliv = delivPriceHT - totalCost - totalPlatformFees;
        const fcDeliv = fcSP; // M√™me FC% car m√™me marge nette

        html += `
        <div style="background: var(--surface); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <input type="text" value="${menu.name}" onchange="updateMenuField(${index}, 'name', this.value)"
                    style="font-size: 1.3rem; font-weight: 700; border: none; background: transparent; flex: 1; color: var(--text);">
                <button class="btn btn-outline btn-sm" style="color: var(--danger);" onclick="deleteMenu(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="font-size: 0.8rem; font-weight: 600; color: var(--text-light); display: block; margin-bottom: 8px;">
                    <i class="fas fa-utensils"></i> Plats inclus dans ce menu
                </label>

                <!-- Tableau d√©taill√© des plats -->
                ${menu.dishes.length > 0 ? `
                <table style="width:100%; border-collapse: collapse; margin-bottom: 12px; font-size: 0.85rem;">
                    <thead>
                        <tr style="background: #f1f5f9;">
                            <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border);">Plat</th>
                            <th style="padding: 8px; text-align: right; border-bottom: 2px solid var(--border);">Co√ªt</th>
                            <th style="padding: 8px; text-align: right; border-bottom: 2px solid var(--border);">Prix Seul</th>
                            <th style="padding: 8px; text-align: right; border-bottom: 2px solid var(--border);">FC%</th>
                            <th style="padding: 8px; text-align: center; border-bottom: 2px solid var(--border);"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${menu.dishes.map((dishId, dishIdx) => {
                            const dish = state.final.find(f => f.id === dishId);
                            if (!dish) return '';
                            const dishCost = calculateCost(dish.items, new Set([dish.id]));
                            const dishPriceTTC = parseFloat(dish.sellingPrice) || 0;
                            const dishPriceHT = dishPriceTTC / (1 + (parseFloat(dish.vat) || 10) / 100);
                            const dishFC = dishPriceHT > 0 ? (dishCost / dishPriceHT) * 100 : 0;
                            const fcColor = dishFC > 35 ? 'var(--danger)' : 'var(--success)';
                            return '<tr style="border-bottom: 1px solid var(--border);">' +
                                '<td style="padding: 8px;"><strong>' + dish.name + '</strong></td>' +
                                '<td style="padding: 8px; text-align: right;">' + dishCost.toFixed(2) + ' ‚Ç¨</td>' +
                                '<td style="padding: 8px; text-align: right;">' + dishPriceTTC.toFixed(2) + ' ‚Ç¨</td>' +
                                '<td style="padding: 8px; text-align: right; font-weight: 700; color: ' + fcColor + ';">' + dishFC.toFixed(0) + '%</td>' +
                                '<td style="padding: 8px; text-align: center;"><button onclick="removeDishFromMenu(' + index + ', ' + dishIdx + ')" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1rem;">√ó</button></td>' +
                            '</tr>';
                        }).join('')}
                        <tr style="background: #e2e8f0; font-weight: 700;">
                            <td style="padding: 8px;">TOTAL MENU</td>
                            <td style="padding: 8px; text-align: right; color: var(--primary);">${menuCost.toFixed(2)} ‚Ç¨</td>
                            <td style="padding: 8px; text-align: right;">${menu.sellingPrice} ‚Ç¨</td>
                            <td style="padding: 8px; text-align: right; color: ${fcSP > 35 ? 'var(--danger)' : 'var(--success)'};">${fcSP.toFixed(0)}%</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
                ` : '<div style="padding: 15px; background: #f1f5f9; border-radius: 8px; text-align: center; color: var(--text-light);">Aucun plat ajout√©</div>'}

                <select onchange="addDishToMenu(${index}, this.value); this.value='';" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border); width: 100%;">
                    <option value="">+ Ajouter un plat...</option>
                    ${state.final.filter(f => !menu.dishes.includes(f.id)).map(f => '<option value="' + f.id + '">' + f.name + '</option>').join('')}
                </select>
            </div>

            <!-- Ligne Emballage + TVA -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: #f1f5f9; border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-weight: 600;"><i class="fas fa-box"></i> Emballage :</span>
                    <input type="number" step="0.01" value="${packagingCost}" onchange="updateMenuField(${index}, 'packagingCost', this.value)" style="width: 70px; font-weight: bold; padding: 5px;"> ‚Ç¨
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-weight: 600;">TVA :</span>
                    <input type="number" value="${menu.vat}" onchange="updateMenuField(${index}, 'vat', this.value)" style="width: 60px; font-weight: bold; padding: 5px;"> %
                </div>
                <div>
                    <span style="font-weight: 600;"><i class="fas fa-calculator"></i> Co√ªt Mat: </span>
                    <span style="color: var(--primary); font-weight: 700;">${menuCost.toFixed(2)} ‚Ç¨</span>
                </div>
            </div>

            <div class="profit-grid">
                <!-- CARD EMPORTER -->
                <div class="profit-card">
                    <div class="profit-header">
                        <div style="display:flex; align-items:center; gap:8px;"><i class="fas fa-shopping-bag" style="color:var(--primary);"></i> Emporter</div>
                    </div>
                    <div class="form-row" style="margin-bottom:15px;">
                        <div style="flex:1;">
                            <label style="font-size:0.7rem; font-weight:700; text-transform:uppercase; color:var(--text-light);">Prix TTC</label>
                            <input type="number" step="0.1" value="${menu.sellingPrice}" onchange="updateMenuField(${index}, 'sellingPrice', this.value)" style="font-size:1.3rem; font-weight:800; color:var(--text); padding:8px; width:100%;">
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:0.7rem; font-weight:700; text-transform:uppercase; color:var(--text-light);">Cible FC %</label>
                            <input type="number" style="font-size:1.3rem; font-weight:800; padding:8px; width:100%; border:2px solid var(--primary);" placeholder="%" onchange="updateMenuPriceFromFC(${index}, this.value, false)">
                        </div>
                        <div style="flex:1; text-align:center;">
                            <label style="font-size:0.7rem; font-weight:700; text-transform:uppercase; color:var(--text-light);">Food Cost</label>
                            <div style="font-size:1.3rem; font-weight:800; padding:8px; color:${fcSP > 35 ? 'var(--danger)' : 'var(--success)'};">${fcSP.toFixed(0)}%</div>
                        </div>
                    </div>

                    <div class="money-bar">
                        <div class="bar-segment bg-tva" style="width:${priceTTC > 0 ? (tvaAmount/priceTTC*100).toFixed(1) : 0}%" title="TVA">TVA</div>
                        <div class="bar-segment bg-cost" style="width:${priceTTC > 0 ? (totalCost/priceTTC*100).toFixed(1) : 0}%" title="Co√ªt">Co√ªt</div>
                        <div class="bar-segment bg-margin" style="width:${priceTTC > 0 ? Math.max(0, marginSP/priceTTC*100).toFixed(1) : 0}%" title="Marge">Marge</div>
                    </div>

                    <div class="legend-table">
                        <div class="legend-row"><div class="legend-label"><span class="dot bg-tva"></span> Part √âtat (TVA)</div> <span>${tvaAmount.toFixed(2)} ‚Ç¨</span></div>
                        <div class="legend-row"><div class="legend-label"><span class="dot bg-cost"></span> Co√ªt Total</div> <span>${totalCost.toFixed(2)} ‚Ç¨ <span style="font-size:0.75rem;opacity:0.7">(Mat: ${menuCost.toFixed(2)}‚Ç¨ + Emb: ${packagingCost.toFixed(2)}‚Ç¨)</span></span></div>
                        <div class="legend-row final-row" style="color:${marginSP < 0 ? 'var(--danger)' : 'var(--success)'};">
                            <div class="legend-label"><span class="dot bg-margin"></span> Reste pour vous</div>
                            <span>${marginSP.toFixed(2)} ‚Ç¨</span>
                        </div>
                    </div>
                </div>

                <!-- CARD LIVRAISON -->
                <div class="profit-card dark-mode">
                    <div class="profit-header">
                        <div style="display:flex; align-items:center; gap:8px;"><i class="fas fa-motorcycle" style="color:#38bdf8;"></i> Livraison (Plateforme)</div>
                    </div>
                    <div class="form-row" style="margin-bottom:8px;">
                        <div style="flex:1.5;">
                            <label style="font-size:0.65rem; font-weight:700; text-transform:uppercase; color:#94a3b8;">Prix TTC (auto)</label>
                            <div style="font-size:1.3rem; font-weight:800; padding:6px; color:#38bdf8;">${delivPriceTTC.toFixed(2)} ‚Ç¨</div>
                        </div>
                        <div style="flex:1; text-align:center;">
                            <label style="font-size:0.65rem; font-weight:700; text-transform:uppercase; color:#94a3b8;">Food Cost</label>
                            <div style="font-size:1.3rem; font-weight:800; padding:6px; color:${fcDeliv > 35 ? '#f87171' : '#4ade80'};">${fcDeliv.toFixed(0)}%</div>
                        </div>
                    </div>
                    <div class="form-row" style="margin-bottom:10px;">
                        <div style="flex:1;">
                            <label style="font-size:0.6rem; font-weight:600; text-transform:uppercase; color:#94a3b8;">Comm %</label>
                            <input type="number" value="${menu.commission}" onchange="updateMenuField(${index}, 'commission', this.value)" style="background:rgba(255,255,255,0.1); color:white; border:none; font-size:0.95rem; font-weight:bold; width:100%; padding:6px;">
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:0.6rem; font-weight:600; text-transform:uppercase; color:#94a3b8;">Frais Liv ‚Ç¨</label>
                            <input type="number" step="0.1" value="${menu.deliveryFee || 0}" onchange="updateMenuField(${index}, 'deliveryFee', this.value)" style="background:rgba(255,255,255,0.1); color:white; border:none; font-size:0.95rem; font-weight:bold; width:100%; padding:6px;">
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:0.6rem; font-weight:600; text-transform:uppercase; color:#94a3b8;">Frais Serv ‚Ç¨</label>
                            <input type="number" step="0.1" value="${menu.serviceFee || 0}" onchange="updateMenuField(${index}, 'serviceFee', this.value)" style="background:rgba(255,255,255,0.1); color:white; border:none; font-size:0.95rem; font-weight:bold; width:100%; padding:6px;">
                        </div>
                    </div>

                    <div class="money-bar" style="opacity:0.9;">
                        <div class="bar-segment bg-tva" style="width:${delivPriceTTC > 0 ? (delivTva/delivPriceTTC*100).toFixed(1) : 0}%" title="TVA"></div>
                        <div class="bar-segment bg-comm" style="width:${delivPriceTTC > 0 ? (totalPlatformFees/delivPriceTTC*100).toFixed(1) : 0}%" title="Plateforme">Plat.</div>
                        <div class="bar-segment bg-cost" style="width:${delivPriceTTC > 0 ? (totalCost/delivPriceTTC*100).toFixed(1) : 0}%" title="Co√ªt">Co√ªt</div>
                        <div class="bar-segment bg-margin" style="width:${delivPriceTTC > 0 ? Math.max(0, marginDeliv/delivPriceTTC*100).toFixed(1) : 0}%" title="Marge"></div>
                    </div>

                    <div class="legend-table">
                        <div class="legend-row"><div class="legend-label"><span class="dot bg-tva"></span> Part √âtat (TVA)</div> <span style="color:#94a3b8;">${delivTva.toFixed(2)} ‚Ç¨</span></div>
                        <div class="legend-row"><div class="legend-label"><span class="dot bg-comm"></span> Part Plateforme</div> <span style="color:#94a3b8;">${totalPlatformFees.toFixed(2)} ‚Ç¨ <span style="font-size:0.7rem;opacity:0.8">(${commPercent}%: ${commAmount.toFixed(2)}‚Ç¨${deliveryFee > 0 ? ' + Liv: ' + deliveryFee.toFixed(2) + '‚Ç¨' : ''}${serviceFee > 0 ? ' + Serv: ' + serviceFee.toFixed(2) + '‚Ç¨' : ''})</span></span></div>
                        <div class="legend-row"><div class="legend-label"><span class="dot bg-cost"></span> Co√ªt Total</div> <span style="color:#94a3b8;">${totalCost.toFixed(2)} ‚Ç¨</span></div>
                        <div class="legend-row final-row" style="color:${marginDeliv < 0 ? '#f87171' : '#4ade80'};">
                            <div class="legend-label"><span class="dot bg-margin"></span> Reste pour vous</div>
                            <span>${marginDeliv.toFixed(2)} ‚Ç¨</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        `;
    });
    container.innerHTML = html;
}

function calculateMenuCost(menu) {
    let total = 0;
    if (menu.dishes && menu.dishes.length > 0) {
        menu.dishes.forEach(dishId => {
            const dish = state.final.find(f => f.id === dishId);
            if (dish) {
                total += calculateCost(dish.items, new Set([dish.id]));
            }
        });
    }
    return total;
}

function updateMenuField(index, field, value) {
    state.menus[index][field] = field === 'name' ? value : (parseFloat(value) || 0);
    saveData();
    renderMenus();
}

function updateMenuPriceFromFC(index, targetFC, isDelivery) {
    const menu = state.menus[index];
    const menuCost = calculateMenuCost(menu);
    const vatRate = parseFloat(menu.vat) || 10;
    const target = parseFloat(targetFC);
    const packagingCost = parseFloat(menu.packagingCost) || 0;
    const totalCost = menuCost + packagingCost;

    if (target > 0 && totalCost > 0) {
        if (isDelivery) {
            // Avec commission% + frais fixes (livraison + service)
            const commPercent = parseFloat(menu.commission) || 30;
            const deliveryFee = parseFloat(menu.deliveryFee) || 0;
            const serviceFee = parseFloat(menu.serviceFee) || 0;
            const priceHTNet = totalCost / (target / 100);
            const priceHT = (priceHTNet + deliveryFee + serviceFee) / (1 - commPercent / 100);
            const priceTTC = priceHT * (1 + (vatRate / 100));
            menu.deliveryPrice = priceTTC.toFixed(2);
        } else {
            const priceHT = totalCost / (target / 100);
            const priceTTC = priceHT * (1 + (vatRate / 100));
            menu.sellingPrice = priceTTC.toFixed(2);
        }
        saveData();
        renderMenus();
    }
}

function addDishToMenu(menuIndex, dishId) {
    if (!dishId) return;
    if (!state.menus[menuIndex].dishes.includes(dishId)) {
        state.menus[menuIndex].dishes.push(dishId);
        saveData();
        renderMenus();
    }
}

function removeDishFromMenu(menuIndex, dishIdx) {
    state.menus[menuIndex].dishes.splice(dishIdx, 1);
    saveData();
    renderMenus();
}

function deleteMenu(index) {
    if (confirm('Supprimer ce menu?')) {
        state.menus.splice(index, 1);
        saveData();
        renderMenus();
    }
}

</script>
</body>
</html>
