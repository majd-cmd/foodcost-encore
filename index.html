<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculateur Food Cost Pro - v3.3 CLOUD</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- LZ-String compression library for URL sharing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #ec4899;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --border: #e2e8f0;
            --tva-color: #94a3b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.5;
            padding-bottom: 80px;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1.5rem 1rem;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.15);
            margin-bottom: 2rem;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 { font-size: 1.5rem; font-weight: 800; display: flex; align-items: center; gap: 12px; letter-spacing: -0.025em; }
        
        .header-actions button {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.25);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            backdrop-filter: blur(4px);
        }
        .header-actions button:hover { background: rgba(255,255,255,0.25); transform: translateY(-1px); }

        /* Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .container { grid-template-columns: 1fr; }
            aside .card { position: static !important; max-height: 400px; overflow: hidden; display: flex; flex-direction: column; }
            .ingredient-list { flex: 1; }
        }

        /* Cards & Generic UI */
        .card {
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        h2 {
            font-size: 1.1rem;
            color: var(--text);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
        }

        /* Ingredients Sidebar */
        .ingredient-list {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .ing-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            transition: background 0.2s;
            border-radius: 8px;
        }
        .ing-item:hover { background-color: #f1f5f9; }
        .ing-details { display: flex; flex-direction: column; }
        .ing-name { font-weight: 600; color: var(--text); }
        .ing-price { font-size: 0.8rem; color: var(--text-light); margin-top: 2px; }

        /* Inputs */
        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
            background: #f8fafc;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            background: white;
        }

        .form-group { margin-bottom: 1rem; }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn-primary { background-color: var(--primary); color: white; box-shadow: 0 2px 8px rgba(79, 70, 229, 0.25); }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-success { background-color: var(--success); color: white; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25); }
        .btn-danger { background-color: #fee2e2; color: var(--danger); }
        .btn-danger:hover { background-color: #fecaca; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; height: 28px; }

        /* Tables & Mobile Response */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin: 1rem 0; }
        th { text-align: left; font-size: 0.75rem; text-transform: uppercase; color: var(--text-light); padding: 12px; background: #f8fafc; border-bottom: 1px solid var(--border); font-weight: 600; letter-spacing: 0.05em; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        tr:last-child td { border-bottom: none; }
        
        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { margin-bottom: 15px; border: 1px solid var(--border); border-radius: 12px; padding: 10px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
            td { border: none; padding: 5px 0; position: relative; }
            td:first-child { font-weight: bold; padding-bottom: 10px; border-bottom: 1px dashed var(--border); margin-bottom: 10px; }
            td input, td select { width: 100%; }
            .form-row { flex-wrap: wrap; }
            .tabs { flex-wrap: wrap; }
        }

        /* Navigation Tabs */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .tab-btn {
            padding: 12px 24px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
            flex: 1;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .tab-btn:hover { background: #f8fafc; color: var(--primary); }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }

        /* Sub Tabs */
        .sub-tabs-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            padding-bottom: 5px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .sub-tab {
            padding: 8px 16px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text);
            transition: all 0.2s;
        }
        .sub-tab:hover { border-color: #cbd5e1; }
        .sub-tab.active { background: #eff6ff; color: var(--primary); border-color: var(--primary); font-weight: 600; }
        .add-tab-btn {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        .add-tab-btn:hover { transform: scale(1.1); }

        /* --- PROFITABILITY VISUALIZER --- */
        .profit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        @media(max-width: 768px) { .profit-grid { grid-template-columns: 1fr; } }
        
        .profit-card { 
            background: white; 
            border: 1px solid var(--border); 
            border-radius: 16px; 
            padding: 20px; 
            display: flex; flex-direction: column;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .profit-card.dark-mode { background: #1e293b; color: white; border:none; }
        
        .profit-header { font-weight: 800; font-size: 1.1rem; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .profit-sub { font-size: 0.85rem; color: var(--text-light); margin-bottom: 15px; }
        .profit-card.dark-mode .profit-sub { color: #94a3b8; }

        .money-bar { 
            height: 36px; 
            display: flex; 
            width: 100%; 
            border-radius: 8px; 
            overflow: hidden; 
            margin: 10px 0 20px 0; 
            background: #f1f5f9;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .bar-segment { 
            height: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-size: 0.7rem; 
            font-weight: 700; 
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            overflow: hidden;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .legend-table { width: 100%; font-size: 0.9rem; }
        .legend-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--border); align-items: center; }
        .profit-card.dark-mode .legend-row { border-color: rgba(255,255,255,0.1); }
        
        .legend-label { display: flex; align-items: center; gap: 8px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        
        .final-row { margin-top: 10px; padding-top: 10px; border-top: 2px solid var(--border); font-weight: 800; font-size: 1.1rem; border-bottom: none; }
        .profit-card.dark-mode .final-row { border-color: rgba(255,255,255,0.2); }

        .bg-cost { background-color: var(--danger); } 
        .bg-margin { background-color: var(--success); } 
        .bg-comm { background-color: var(--warning); } 
        .bg-tva { background-color: var(--tva-color); } 

        /* Recipe Stats (Common) */
        .recipe-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px; }
        .stat-box { background:#f8fafc; padding:15px; border-radius:10px; border:1px solid var(--border); }
        .stat-label { margin-bottom:5px; font-weight:600; font-size: 0.8rem; color: var(--text-light); }
        .stat-value { font-size:1.2rem; font-weight:bold; color: var(--text); }

        /* Dashboard specific */
        .dashboard-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        @media (max-width: 768px) { .dashboard-row { grid-template-columns: 1fr; } }
        .dash-kpi { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 15px; text-align: center; }
        .dash-kpi-val { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        .dash-kpi-lbl { font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em;}

        .recipe-header { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .hidden { display: none; }
        .badge { padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .badge-auto { background: #dcfce7; color: #15803d; }
        .badge-manual { background: #fef9c3; color: #a16207; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); font-style: italic; background: #f8fafc; border-radius: 16px; border: 2px dashed var(--border); }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }

        /* Cloud Sync Styles */
        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            margin-left: 10px;
        }
        .sync-indicator.synced { color: #4ade80; }
        .sync-indicator.syncing { color: #fbbf24; }
        .sync-indicator.error { color: #f87171; }
        .sync-indicator.local { color: #94a3b8; }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        .sync-indicator.syncing .sync-dot {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .share-btn {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            border: none !important;
        }
        .share-btn:hover {
            background: linear-gradient(135deg, #059669, #047857) !important;
        }

        .share-modal-content {
            text-align: center;
        }
        .share-url-container {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .share-url-input {
            flex: 1;
            font-size: 0.85rem;
            background: #f1f5f9;
            border: 2px solid var(--border);
            padding: 12px;
            border-radius: 8px;
        }
        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .copy-btn:hover {
            background: var(--primary-dark);
        }
        .copy-btn.copied {
            background: var(--success);
        }

        .cloud-info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            font-size: 0.85rem;
            color: #1e40af;
        }
        .cloud-info i {
            margin-right: 8px;
        }

        .shared-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: 15px;
        }

    </style>
</head>
<body>

<header>
    <div class="header-content">
        <h1>
            <i class="fas fa-chart-pie"></i> FoodCost Pro
            <span id="sharedBadge" class="shared-badge hidden"><i class="fas fa-cloud"></i> Cloud</span>
            <span id="syncIndicator" class="sync-indicator local"><span class="sync-dot"></span> Local</span>
        </h1>
        <div class="header-actions">
            <button class="share-btn" onclick="shareData()"><i class="fas fa-share-alt"></i> Partager</button>
            <button onclick="exportData()"><i class="fas fa-download"></i> Sauvegarder</button>
            <button onclick="document.getElementById('fileInput').click()"><i class="fas fa-upload"></i> Charger</button>
            <input type="file" id="fileInput" class="hidden" onchange="importData(this)">
            <button onclick="resetData()" style="background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.5);">Reset</button>
        </div>
    </div>
</header>

<div class="container">
    <aside>
        <div class="card" style="height: fit-content; position: sticky; top: 20px;">
            <h2>
                Ingr√©dients 
                <button class="btn btn-primary btn-sm" onclick="openIngredientModal()">+ Nouveau</button>
            </h2>
            <input type="text" id="searchIngredient" placeholder="üîç Rechercher..." oninput="renderIngredients()" style="margin-bottom: 15px;">
            <div class="ingredient-list" id="ingredientsList"></div>
        </div>
    </aside>

    <main>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchView('intermediate')" id="btn-view-int"><i class="fas fa-blender"></i> Pr√©parations</button>
            <button class="tab-btn" onclick="switchView('final')" id="btn-view-final"><i class="fas fa-utensils"></i> Plats</button>
        </div>

        <div id="view-intermediate">
            <div class="card">
                 <div class="sub-tabs-container" id="int-sub-tabs"></div>
                <div id="intermediateRecipeContent"></div>
            </div>
        </div>

        <div id="view-final" class="hidden">
            <div class="dashboard-row" id="globalDashboard">
                <div class="dash-kpi">
                    <div class="dash-kpi-val" id="dash-margin">--%</div>
                    <div class="dash-kpi-lbl">Marge Moyenne</div>
                </div>
                <div class="dash-kpi">
                    <div class="dash-kpi-val" id="dash-fc">--%</div>
                    <div class="dash-kpi-lbl">Food Cost Moyen</div>
                </div>
                <div class="dash-kpi">
                    <div class="dash-kpi-val text-success" id="dash-ok-count">0</div>
                    <div class="dash-kpi-lbl">Plats Rentables (>70%)</div>
                </div>
            </div>

            <div class="card">
                <div class="sub-tabs-container" id="fin-sub-tabs"></div>
               <div id="finalRecipeContent"></div>
           </div>
        </div>
    </main>
</div>

<!-- MODAL -->
<div id="ingredientModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000; backdrop-filter: blur(5px);">
    <div class="card" style="width: 400px; margin:0; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
        <h2 style="margin-bottom: 20px;">Ajouter Ingr√©dient</h2>
        <div class="form-group">
            <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block;">Nom</label>
            <input type="text" id="newIngName" placeholder="Ex: Tomates Cerises">
        </div>
        <div class="form-row">
            <div style="flex:1">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block;">Prix (‚Ç¨)</label>
                <input type="number" id="newIngPrice" step="0.01" placeholder="0.00">
            </div>
            <div style="flex:1">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block;">Pour</label>
                <select id="newIngUnit">
                    <option value="kg">1 kg</option>
                    <option value="g">1 g</option>
                    <option value="L">1 L</option>
                    <option value="ml">1 ml</option>
                    <option value="piece">1 pi√®ce</option>
                </select>
            </div>
        </div>
        <div class="flex-between" style="margin-top: 20px;">
            <button class="btn btn-danger" onclick="closeIngredientModal()">Annuler</button>
            <button class="btn btn-primary" onclick="saveNewIngredient()">Enregistrer</button>
        </div>
    </div>
</div>

<!-- SHARE MODAL -->
<div id="shareModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000; backdrop-filter: blur(5px);">
    <div class="card" style="width: 500px; max-width: 90%; margin:0; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
        <div class="share-modal-content">
            <h2 style="justify-content: center; margin-bottom: 10px;">
                <i class="fas fa-share-alt" style="color: var(--primary); margin-right: 10px;"></i>
                Partager vos recettes
            </h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Copiez ce lien pour partager vos recettes avec d'autres personnes.
            </p>

            <div id="shareLoading" style="padding: 30px; display: none;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary);"></i>
                <p style="margin-top: 10px; color: var(--text-light);">Creation du lien...</p>
            </div>

            <div id="shareResult" style="display: none;">
                <div class="share-url-container">
                    <input type="text" id="shareUrlInput" class="share-url-input" readonly>
                    <button class="copy-btn" onclick="copyShareUrl()">
                        <i class="fas fa-copy"></i> Copier
                    </button>
                </div>

                <div class="cloud-info">
                    <i class="fas fa-info-circle"></i>
                    Ce lien contient toutes vos donnees actuelles. Si vous modifiez vos recettes, regenerez un nouveau lien pour partager les modifications.
                </div>
            </div>

            <div id="shareError" style="display: none; color: var(--danger); padding: 20px;">
                <i class="fas fa-exclamation-triangle"></i>
                <p id="shareErrorMessage">Une erreur est survenue</p>
            </div>
        </div>

        <div class="flex-between" style="margin-top: 20px;">
            <button class="btn btn-outline" onclick="closeShareModal()">Fermer</button>
            <button class="btn btn-primary" onclick="shareData()" id="regenerateBtn">
                <i class="fas fa-sync"></i> Regenerer le lien
            </button>
        </div>
    </div>
</div>

<script>
/* --- CONFIG STORAGE KEY --- */
const STORAGE_KEY = 'foodCostPro_v3_COMPLETE';

/* --- URL SHARING (no server needed) --- */
let isSharedMode = false;

/* --- DONNEES INITIALES (COPIE DE TA LISTE) --- */
let state = { ingredients: [], intermediate: [], final: [] };
let activeIntIndex = 0; let activeFinIndex = 0;

const initialData = {
    ingredients: [
        {id: 1, name: "Ail en Poudre", price: 10.70, unit: "kg"},
        {id: 2, name: "Ail frais", price: 4.94, unit: "kg"},
        {id: 3, name: "Ail Semoule", price: 11.17, unit: "kg"},
        {id: 4, name: "Basilic", price: 1.10, unit: "piece"},
        {id: 5, name: "Beurre", price: 11.03, unit: "kg"},
        {id: 6, name: "Blanc d'Oeuf", price: 6.33, unit: "kg"},
        {id: 7, name: "Buns", price: 0.50, unit: "piece"},
        {id: 8, name: "Cheddar", price: 0.11, unit: "piece"},
        {id: 9, name: "Cheddar Blanc", price: 0.11, unit: "piece"},
        {id: 10, name: "Chocolat Blanc", price: 14.21, unit: "kg"},
        {id: 11, name: "Coriandre Fraiche", price: 1.20, unit: "piece"},
        {id: 12, name: "Cornichon", price: 6.69, unit: "kg"},
        {id: 13, name: "Coulis de Chocolat", price: 6.57, unit: "kg"},
        {id: 14, name: "Cream Cheese", price: 9.48, unit: "kg"},
        {id: 15, name: "Cr√®me Liquide 35%mg", price: 4.86, unit: "L"},
        {id: 16, name: "Cr√®me Vanille", price: 6.96, unit: "kg"},
        {id: 17, name: "Croutons", price: 0.00, unit: "kg"},
        {id: 18, name: "Docello Pistache", price: 38.79, unit: "kg"},
        {id: 19, name: "Edamame", price: 3.59, unit: "kg"},
        {id: 20, name: "Extrait de Vanille Sebalc√©", price: 72.64, unit: "kg"},
        {id: 21, name: "Farine", price: 0.79, unit: "kg"},
        {id: 22, name: "Filet de B≈ìuf", price: 21.00, unit: "kg"},
        {id: 23, name: "G√©latine Bronze Bovine", price: 47.23, unit: "kg"},
        {id: 24, name: "Haut de cuisse Jacob", price: 6.47, unit: "kg"},
        {id: 25, name: "Huile d'Olive", price: 0.00, unit: "kg"},
        {id: 26, name: "Huile de Tournesol", price: 1.79, unit: "L"},
        {id: 27, name: "Huile de Truffe Blanche", price: 0.00, unit: "L"},
        {id: 28, name: "Huile de Truffe Noire", price: 62.00, unit: "L"},
        {id: 29, name: "Huile S√©same", price: 12.56, unit: "L"},
        {id: 30, name: "Jaune d'Oeuf", price: 6.42, unit: "kg"},
        {id: 31, name: "Jus de Citron Metro chef", price: 4.38, unit: "L"},
        {id: 32, name: "Jus de Veau Li√© M√©tro Chef", price: 16.04, unit: "kg"},
        {id: 33, name: "Jus de Yuzu Siracuse", price: 51.00, unit: "L"},
        {id: 34, name: "Ketchup", price: 3.61, unit: "kg"},
        {id: 35, name: "Lait Entier", price: 1.13, unit: "L"},
        {id: 36, name: "M&M's", price: 0.00, unit: "kg"},
        {id: 37, name: "Mayonnaise Citron", price: 2.81, unit: "kg"},
        {id: 38, name: "Merlan de B≈ìuf", price: 18.00, unit: "kg"},
        {id: 39, name: "Mini Piment Padron", price: 5.48, unit: "kg"},
        {id: 40, name: "Moutarde Dijon", price: 2.13, unit: "kg"},
        {id: 41, name: "Oignon C√©bette", price: 10.00, unit: "kg"},
        {id: 42, name: "Oignon en d√©s", price: 1.98, unit: "kg"},
        {id: 43, name: "Oignon Frit", price: 7.57, unit: "kg"},
        {id: 44, name: "Pain Bao", price: 0.54, unit: "piece"},
        {id: 45, name: "Paleron de Boeuf", price: 13.50, unit: "kg"},
        {id: 46, name: "Paprika Fum√©", price: 37.00, unit: "kg"},
        {id: 47, name: "Parmesan en Poudre", price: 23.30, unit: "kg"},
        {id: 48, name: "Pic en Bois", price: 0.01, unit: "piece"},
        {id: 49, name: "Pickles Oigon Rouge", price: 14.92, unit: "kg"},
        {id: 50, name: "Piment Chiliflakes", price: 16.10, unit: "kg"},
        {id: 51, name: "Piment d'Espelette", price: 111.00, unit: "kg"},
        {id: 52, name: "Piment Oiseaux", price: 30.08, unit: "kg"},
        {id: 53, name: "Piment Pilipili Moulu", price: 10.30, unit: "kg"},
        {id: 54, name: "Ponthier Mangue", price: 9.41, unit: "kg"},
        {id: 55, name: "Poudre d'Olive Sosa", price: 146.00, unit: "kg"},
        {id: 56, name: "Poudre de Gingembre", price: 22.50, unit: "kg"},
        {id: 57, name: "Pur√©e", price: 4.16, unit: "kg"},
        {id: 58, name: "Pur√©e de Gingembre", price: 14.64, unit: "kg"},
        {id: 59, name: "Pur√©e Lutosa", price: 3.30, unit: "kg"},
        {id: 60, name: "Riz au Lait", price: 5.36, unit: "kg"},
        {id: 61, name: "Riz Rond", price: 2.09, unit: "kg"},
        {id: 62, name: "Salade Iceberg", price: 2.00, unit: "kg"},
        {id: 63, name: "Salade Wakame", price: 11.69, unit: "kg"},
        {id: 64, name: "Sauce C√©sar", price: 0.00, unit: "L"},
        {id: 65, name: "Sauce Dynamite", price: 7.13, unit: "kg"},
        {id: 66, name: "Sauce Soja Sal√©", price: 8.91, unit: "L"},
        {id: 67, name: "Sauce Soja Sucr√©", price: 8.20, unit: "L"},
        {id: 68, name: "Sauce Sriracha", price: 6.63, unit: "kg"},
        {id: 69, name: "Sauce Tiger", price: 8.35, unit: "kg"},
        {id: 70, name: "Sauce Truffe", price: 17.57, unit: "kg"},
        {id: 71, name: "Sel Fin", price: 0.85, unit: "kg"},
        {id: 72, name: "Sosa Poudre Fum√©e", price: 0.00, unit: "kg"},
        {id: 73, name: "Sosa S√©same Noir Crispy", price: 0.00, unit: "kg"},
        {id: 74, name: "Steak Hach√© Metzger", price: 16.00, unit: "kg"},
        {id: 75, name: "Sucre", price: 6.29, unit: "kg"},
        {id: 76, name: "Tartipat Noisette Blanc", price: 0.00, unit: "kg"},
        {id: 77, name: "Tranche Piment Jalapeno", price: 0.02, unit: "piece"},
        {id: 78, name: "Viande √† Bao", price: 12.61, unit: "kg"},
        {id: 79, name: "Vinaigre de Cidre", price: 2.87, unit: "L"}
    ],
    intermediate: [
        { id: 'INT_1', name: "Riz au Lait", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 61, quantity: 90, unit: 'g'}, {id: 75, quantity: 40, unit: 'g'}, {id: 10, quantity: 40, unit: 'g'}, {id: 20, quantity: 30, unit: 'g'}, {id: 15, quantity: 330, unit: 'ml'}, {id: 35, quantity: 500, unit: 'ml'}, {id: 71, quantity: 1, unit: 'g'}] },
        { id: 'INT_2', name: "Cr√®me Vanille", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 10, quantity: 2.5, unit: 'kg'}, {id: 20, quantity: 250, unit: 'g'}, {id: 35, quantity: 3, unit: 'L'}, {id: 15, quantity: 3, unit: 'L'}, {id: 23, quantity: 120, unit: 'g'}] },
        { id: 'INT_3', name: "Sauce Dynamite", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 68, quantity: 400, unit: 'g'}, {id: 14, quantity: 300, unit: 'g'}, {id: 40, quantity: 100, unit: 'g'}] },
        { id: 'INT_4', name: "Sauce Tiger", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 67, quantity: 4, unit: 'L'}, {id: 66, quantity: 750, unit: 'ml'}, {id: 58, quantity: 200, unit: 'g'}, {id: 2, quantity: 500, unit: 'g'}, {id: 11, quantity: 15, unit: 'piece'}, {id: 26, quantity: 4, unit: 'L'}, {id: 52, quantity: 100, unit: 'g'}, {id: 29, quantity: 1.5, unit: 'L'}] },
        { id: 'INT_5', name: "Sauce Yuzu", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 33, quantity: 100, unit: 'ml'}, {id: 14, quantity: 100, unit: 'g'}, {id: 28, quantity: 100, unit: 'ml'}, {id: 40, quantity: 50, unit: 'g'}] },
        { id: 'INT_6', name: "Pur√©e", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 59, quantity: 7.5, unit: 'kg'}, {id: 35, quantity: 4, unit: 'L'}, {id: 5, quantity: 3, unit: 'kg'}, {id: 71, quantity: 90, unit: 'g'}, {id: 72, quantity: 90, unit: 'g'}] },
        { id: 'INT_7', name: "Viande √† Bao", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 45, quantity: 10, unit: 'kg'}, {id: 32, quantity: 500, unit: 'g'}, {id: 46, quantity: 500, unit: 'g'}, {id: 'INT_4', quantity: 1, unit: 'L'}] },
        { id: 'INT_8', name: "Sauce C√©sar", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 40, quantity: 100, unit: 'g'}, {id: 25, quantity: 1, unit: 'L'}, {id: 47, quantity: 250, unit: 'g'}, {id: 2, quantity: 4, unit: 'g'}] },
        { id: 'INT_9', name: "Mayonnaise Citron", manualYield: false, yield: 0, yieldUnit: 'g', lossPercent: 0, items: [{id: 30, quantity: 200, unit: 'g'}, {id: 40, quantity: 100, unit: 'g'}, {id: 26, quantity: 1, unit: 'L'}, {id: 31, quantity: 300, unit: 'ml'}, {id: 71, quantity: 50, unit: 'g'}] }
    ],
    final: [
        { id: 'FIN_1', name: "Dynamite Burger", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 7, quantity: 1, unit: 'piece'}, {id: 74, quantity: 120, unit: 'g'}, {id: 8, quantity: 3, unit: 'piece'}, {id: 'INT_3', quantity: 40, unit: 'g'}, {id: 39, quantity: 10, unit: 'g'}, {id: 49, quantity: 10, unit: 'g'}, {id: 41, quantity: 5, unit: 'g'}] },
        { id: 'FIN_2', name: "Tiger Burger", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 7, quantity: 1, unit: 'piece'}, {id: 74, quantity: 120, unit: 'g'}, {id: 8, quantity: 3, unit: 'piece'}, {id: 'INT_4', quantity: 40, unit: 'g'}, {id: 68, quantity: 5, unit: 'g'}, {id: 43, quantity: 5, unit: 'g'}] },
        { id: 'FIN_3', name: "Yuzu Burger", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 7, quantity: 1, unit: 'piece'}, {id: 74, quantity: 120, unit: 'g'}, {id: 9, quantity: 3, unit: 'piece'}, {id: 70, quantity: 40, unit: 'g'}, {id: 62, quantity: 20, unit: 'g'}, {id: 12, quantity: 10, unit: 'g'}] },
        { id: 'FIN_4', name: "Classic", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 7, quantity: 1, unit: 'piece'}, {id: 74, quantity: 120, unit: 'g'}, {id: 8, quantity: 3, unit: 'piece'}, {id: 34, quantity: 10, unit: 'g'}, {id: 40, quantity: 5, unit: 'g'}, {id: 42, quantity: 5, unit: 'g'}, {id: 12, quantity: 10, unit: 'g'}] },
        { id: 'FIN_5', name: "Boeuf Tiger", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 22, quantity: 150, unit: 'g'}, {id: 48, quantity: 1, unit: 'piece'}, {id: 'INT_4', quantity: 20, unit: 'g'}, {id: 68, quantity: 5, unit: 'g'}, {id: 43, quantity: 5, unit: 'g'}, {id: 41, quantity: 5, unit: 'g'}] },
        { id: 'FIN_6', name: "Pur√©e (Plat)", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 'INT_6', quantity: 200, unit: 'g'}, {id: 'INT_4', quantity: 20, unit: 'g'}] },
        { id: 'FIN_7', name: "Bao", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 44, quantity: 1, unit: 'piece'}, {id: 'INT_7', quantity: 15, unit: 'g'}, {id: 'INT_4', quantity: 5, unit: 'g'}, {id: 43, quantity: 10, unit: 'g'}, {id: 49, quantity: 5, unit: 'g'}, {id: 41, quantity: 5, unit: 'g'}, {id: 68, quantity: 5, unit: 'g'}] },
        { id: 'FIN_8', name: "Wrap Salad", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [{id: 62, quantity: 200, unit: 'g'}, {id: 14, quantity: 40, unit: 'g'}, {id: 'INT_9', quantity: 20, unit: 'g'}, {id: 43, quantity: 10, unit: 'g'}, {id: 19, quantity: 60, unit: 'g'}, {id: 47, quantity: 25, unit: 'g'}, {id: 55, quantity: 1, unit: 'g'}, {id: 50, quantity: 2, unit: 'g'}] }
    ]
};

/* --- INIT --- */
window.onload = function() {
    // Check for shared data in URL
    const urlParams = new URLSearchParams(window.location.search);
    const sharedData = urlParams.get('data');

    if (sharedData) {
        // Decompress and load shared data
        try {
            const decompressed = LZString.decompressFromEncodedURIComponent(sharedData);
            if (decompressed) {
                state = JSON.parse(decompressed);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                isSharedMode = true;
                showSharedBadge();
                updateSyncIndicator('synced');
            } else {
                loadData();
                updateSyncIndicator('error');
            }
        } catch (err) {
            console.error('Error loading shared data:', err);
            loadData();
            updateSyncIndicator('error');
        }
    } else {
        loadData();
        updateSyncIndicator('local');
    }

    updateDashboard();
    renderAll();
};

/* --- CLOUD SYNC FUNCTIONS --- */
function updateSyncIndicator(status) {
    const indicator = document.getElementById('syncIndicator');
    if (!indicator) return;

    indicator.className = 'sync-indicator ' + status;

    switch(status) {
        case 'synced':
            indicator.innerHTML = '<span class="sync-dot"></span> Synchronise';
            break;
        case 'syncing':
            indicator.innerHTML = '<span class="sync-dot"></span> Synchronisation...';
            break;
        case 'error':
            indicator.innerHTML = '<span class="sync-dot"></span> Erreur';
            break;
        case 'local':
        default:
            indicator.innerHTML = '<span class="sync-dot"></span> Local';
            break;
    }
}

function showSharedBadge() {
    const badge = document.getElementById('sharedBadge');
    if (badge) {
        badge.classList.remove('hidden');
    }
}

function hideSharedBadge() {
    const badge = document.getElementById('sharedBadge');
    if (badge) {
        badge.classList.add('hidden');
    }
}

function generateShareUrl() {
    // Compress state data and create URL
    const jsonStr = JSON.stringify(state);
    const compressed = LZString.compressToEncodedURIComponent(jsonStr);
    return `${window.location.origin}${window.location.pathname}?data=${compressed}`;
}

/* --- SHARE MODAL FUNCTIONS --- */
function openShareModal() {
    document.getElementById('shareModal').style.display = "flex";
}

function closeShareModal() {
    document.getElementById('shareModal').style.display = "none";
}

function shareData() {
    openShareModal();

    const loadingEl = document.getElementById('shareLoading');
    const resultEl = document.getElementById('shareResult');
    const errorEl = document.getElementById('shareError');
    const disconnectBtn = document.getElementById('disconnectBtn');

    // Reset modal state
    loadingEl.style.display = 'none';
    resultEl.style.display = 'none';
    errorEl.style.display = 'none';
    disconnectBtn.style.display = 'none';

    try {
        // Generate share URL with compressed data
        const shareUrl = generateShareUrl();

        // Check URL length (most browsers support ~8000 chars)
        if (shareUrl.length > 8000) {
            errorEl.style.display = 'block';
            document.getElementById('shareErrorMessage').textContent =
                'Vos donnees sont trop volumineuses pour etre partagees par lien (' +
                Math.round(shareUrl.length/1000) + 'KB). Utilisez le bouton "Sauvegarder" pour exporter un fichier JSON.';
            return;
        }

        document.getElementById('shareUrlInput').value = shareUrl;
        resultEl.style.display = 'block';

        // Update UI
        isSharedMode = true;
        showSharedBadge();
        updateSyncIndicator('synced');

    } catch (err) {
        errorEl.style.display = 'block';
        document.getElementById('shareErrorMessage').textContent = 'Erreur: ' + err.message;
    }
}

function copyShareUrl() {
    const input = document.getElementById('shareUrlInput');
    input.select();
    input.setSelectionRange(0, 99999);

    navigator.clipboard.writeText(input.value).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.classList.add('copied');
        btn.innerHTML = '<i class="fas fa-check"></i> Copie!';

        setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = '<i class="fas fa-copy"></i> Copier';
        }, 2000);
    });
}

function disconnectCloud() {
    if (confirm('Retourner en mode local? Le lien de partage ne sera plus valide.')) {
        isSharedMode = false;
        hideSharedBadge();
        updateSyncIndicator('local');

        // Remove share parameter from URL
        window.history.replaceState({}, '', window.location.pathname);

        closeShareModal();
    }
}

function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    updateDashboard();
    // Note: With URL sharing, user must regenerate link to share updates
    if (isSharedMode) {
        updateSyncIndicator('local'); // Indicate data has changed locally
    }
}

function loadData() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) state = JSON.parse(saved);
    else state = JSON.parse(JSON.stringify(initialData));
}

function resetData() {
    if(confirm("Tout effacer et recharger la carte par defaut ?")) {
        localStorage.removeItem(STORAGE_KEY);
        state = JSON.parse(JSON.stringify(initialData));
        activeIntIndex = 0; activeFinIndex = 0;
        isSharedMode = false;
        hideSharedBadge();
        updateSyncIndicator('local');
        window.history.replaceState({}, '', window.location.pathname);
        renderAll();
    }
}

function exportData() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
    const node = document.createElement('a');
    node.setAttribute("href", dataStr);
    node.setAttribute("download", "mes_recettes.json");
    document.body.appendChild(node);
    node.click();
    node.remove();
}

function importData(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            state = JSON.parse(e.target.result);
            activeIntIndex = 0; activeFinIndex = 0;
            saveData(); renderAll();
        } catch(err) { console.error("Erreur.", err); }
    };
    reader.readAsText(file);
}

function renderAll() {
    renderIngredients();
    renderIntermediateRecipes();
    renderFinalRecipes();
}

function switchView(view) {
    document.getElementById('view-intermediate').classList.add('hidden');
    document.getElementById('view-final').classList.add('hidden');
    document.getElementById('btn-view-int').classList.remove('active');
    document.getElementById('btn-view-final').classList.remove('active');
    document.getElementById('view-' + view).classList.remove('hidden');
    document.getElementById('btn-view-' + (view === 'intermediate' ? 'int' : 'final')).classList.add('active');
    if(view === 'final') updateDashboard();
}

function switchSubTab(type, index) {
    if (type === 'intermediate') { activeIntIndex = index; renderIntermediateRecipes(); } 
    else { activeFinIndex = index; renderFinalRecipes(); }
}

/* --- SECURE DELETE --- */
function checkUsage(id) {
    for (let r of state.intermediate) { if (r.items.some(i => i.id == id)) return `Utilis√© dans la pr√©paration: "${r.name}"`; }
    for (let r of state.final) { if (r.items.some(i => i.id == id)) return `Utilis√© dans le plat: "${r.name}"`; }
    return null;
}

function deleteIngredient(id) {
    const usage = checkUsage(id);
    if(usage) { alert("Impossible de supprimer cet ingr√©dient.\n" + usage); return; }
    if(confirm("Supprimer cet ingr√©dient ?")) {
        state.ingredients = state.ingredients.filter(i => i.id !== id);
        saveData(); renderAll();
    }
}

function deleteRec(type, index) {
    const recipe = state[type][index];
    if (type === 'intermediate') {
        const usage = checkUsage(recipe.id);
        if(usage) { alert("Impossible de supprimer cette pr√©paration.\n" + usage); return; }
    }
    if(confirm(`Supprimer "${recipe.name}" ?`)) {
        state[type].splice(index, 1);
        if (type === 'intermediate') { activeIntIndex = Math.max(0, Math.min(activeIntIndex, state.intermediate.length - 1)); renderIntermediateRecipes(); } 
        else { activeFinIndex = Math.max(0, Math.min(activeFinIndex, state.final.length - 1)); renderFinalRecipes(); }
        saveData();
    }
}

/* --- CALCULS --- */
function normalizeUnit(val, unit) {
    if (unit === 'kg' || unit === 'L') return val * 1000;
    if (unit === 'cl') return val * 10;
    if (unit === 'dl') return val * 100;
    return val; 
}

function calculateCost(items, visitedIds = new Set()) {
    let total = 0;
    items.forEach(item => {
        let component = state.ingredients.find(i => i.id == item.id);
        let isInter = false;
        if (!component) { component = state.intermediate.find(r => r.id == item.id); isInter = true; }
        
        if (component) {
            if (isInter && visitedIds.has(component.id)) return; 
            let pricePerUnit = 0;
            if (isInter) {
                const nextVisited = new Set(visitedIds);
                nextVisited.add(component.id);
                const subTotal = calculateCost(component.items, nextVisited);
                const yieldVal = normalizeUnit(component.yield, component.yieldUnit);
                pricePerUnit = yieldVal > 0 ? subTotal / yieldVal : 0;
            } else {
                if (component.unit === 'kg' || component.unit === 'L') pricePerUnit = component.price / 1000;
                else if (component.unit === 'g' || component.unit === 'ml') pricePerUnit = component.price; 
                else if (component.unit === 'cl') pricePerUnit = component.price / 10;
                else pricePerUnit = component.price; 
            }
            let qty = item.quantity;
            if (item.unit === 'kg' || item.unit === 'L') qty *= 1000;
            if (item.unit === 'cl') qty *= 10;
            if (item.unit === 'dl') qty *= 100;
            total += qty * pricePerUnit;
        }
    });
    return total;
}

function calculateTheoreticalWeight(items) {
    let total = 0;
    items.forEach(item => {
        if (item.unit === 'piece') return;
        let qty = item.quantity;
        if (item.unit === 'kg' || item.unit === 'L') qty *= 1000;
        if (item.unit === 'cl') qty *= 10;
        if (item.unit === 'dl') qty *= 100;
        total += qty;
    });
    return total;
}

function updateDashboard() {
    let totalHT = 0; let totalCost = 0; let profitableCount = 0;
    state.final.forEach(r => {
        const cost = calculateCost(r.items);
        const vatRate = parseFloat(r.vat) || 0;
        const priceHT = (parseFloat(r.sellingPrice) || 0) / (1 + (vatRate/100));
        if (priceHT > 0) {
            totalHT += priceHT; totalCost += cost;
            const margin = ((priceHT - cost) / priceHT) * 100;
            if (margin >= 70) profitableCount++;
        }
    });
    const avgMargin = totalHT > 0 ? ((totalHT - totalCost) / totalHT) * 100 : 0;
    const avgFc = totalHT > 0 ? (totalCost / totalHT) * 100 : 0;
    const elMargin = document.getElementById('dash-margin');
    const elFc = document.getElementById('dash-fc');
    const elCount = document.getElementById('dash-ok-count');
    if(elMargin) {
        elMargin.innerText = avgMargin.toFixed(1) + '%';
        elMargin.className = "dash-kpi-val " + (avgMargin >= 70 ? "text-success" : (avgMargin < 60 ? "text-danger" : "text-warning"));
    }
    if(elFc) elFc.innerText = avgFc.toFixed(1) + '%';
    if(elCount) elCount.innerText = profitableCount + " / " + state.final.length;
}

function renderIngredients() {
    const list = document.getElementById('ingredientsList');
    const search = document.getElementById('searchIngredient').value.toLowerCase();
    list.innerHTML = '';
    state.ingredients.sort((a, b) => a.name.localeCompare(b.name)).filter(i => i.name.toLowerCase().includes(search)).forEach(ing => {
        const div = document.createElement('div');
        div.className = 'ing-item';
        div.innerHTML = `<div class="ing-details"><span class="ing-name">${ing.name}</span><span class="ing-price">${ing.price.toFixed(2)} ‚Ç¨ / ${ing.unit}</span></div><button class="btn btn-outline btn-sm" style="color:var(--danger); border-color:transparent" onclick="deleteIngredient(${ing.id})"><i class="fas fa-trash"></i></button>`;
        list.appendChild(div);
    });
}

function openIngredientModal() { document.getElementById('ingredientModal').style.display = "flex"; }
function closeIngredientModal() { document.getElementById('ingredientModal').style.display = "none"; }

function saveNewIngredient() {
    const name = document.getElementById('newIngName').value;
    const price = parseFloat(document.getElementById('newIngPrice').value);
    const unit = document.getElementById('newIngUnit').value;
    if(name && !isNaN(price)) {
        state.ingredients.push({ id: Date.now(), name, price, unit });
        saveData(); renderAll(); closeIngredientModal();
    }
}

function getIngredientSelectOptions(currentId, excludeRecipeId) {
    let html = '<option value="">Choisir...</option>';
    const sortedIng = [...state.ingredients].sort((a,b) => a.name.localeCompare(b.name));
    html += '<optgroup label="Ingr√©dients">';
    sortedIng.forEach(ing => { html += `<option value="${ing.id}" ${ing.id == currentId ? 'selected' : ''}>${ing.name}</option>`; });
    html += '</optgroup>';
    if (state.intermediate.length > 0) {
        const sortedInter = [...state.intermediate].sort((a,b) => a.name.localeCompare(b.name));
        html += '<optgroup label="Pr√©parations">';
        sortedInter.forEach(rec => { if (rec.id !== excludeRecipeId) { html += `<option value="${rec.id}" ${rec.id == currentId ? 'selected' : ''}>${rec.name}</option>`; } });
        html += '</optgroup>';
    }
    return html;
}

function updateRecipeCalculations(type, index) {
    const recipe = state[type][index];
    const cost = calculateCost(recipe.items, new Set([recipe.id])); 
    
    if (type === 'intermediate') {
        const theoreticalWeight = calculateTheoreticalWeight(recipe.items);
        if(recipe.manualYield) {
           const currentYield = normalizeUnit(recipe.yield, recipe.yieldUnit);
           if(theoreticalWeight > 0) { recipe.lossPercent = Math.max(0, (1 - (currentYield / theoreticalWeight)) * 100); }
        } else {
            const loss = parseFloat(recipe.lossPercent) || 0;
            const newYield = theoreticalWeight * (1 - (loss/100));
            if(recipe.yieldUnit === 'kg' || recipe.yieldUnit === 'L') recipe.yield = newYield / 1000;
            else if (recipe.yieldUnit === 'cl') recipe.yield = newYield / 10;
            else recipe.yield = newYield;
        }
        const yieldG = normalizeUnit(recipe.yield, recipe.yieldUnit);
        const pricePerKg = yieldG > 0 ? (cost / yieldG) * 1000 : 0;
        const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
        setTxt(`int-cost-${index}`, cost.toFixed(2) + ' ‚Ç¨');
        const elWeight = document.getElementById(`int-theo-weight-${index}`);
        if(elWeight) elWeight.innerHTML = `<strong>${theoreticalWeight.toFixed(0)} g</strong>`;
        setTxt(`int-pricekg-${index}`, pricePerKg.toFixed(2) + ' ‚Ç¨ / kg');
        const elBadge = document.getElementById(`int-badge-${index}`);
        if(elBadge) elBadge.innerHTML = recipe.manualYield ? '<span class="badge badge-manual">Manuel</span>' : '<span class="badge badge-auto">Auto</span>';
        setVal(`int-loss-input-${index}`, (recipe.lossPercent || 0).toFixed(1));
        if(!recipe.manualYield) setVal(`int-yield-input-${index}`, parseFloat(recipe.yield).toFixed(2));

    } else if (type === 'final') {
        // UPDATE ONLY DOM ELEMENTS, DO NOT RE-RENDER WHOLE VIEW
        const vatRate = parseFloat(recipe.vat) || 0;
        
        // 1. Update Table Costs
        recipe.items.forEach((item, itemIdx) => {
            const cell = document.getElementById(`fin-item-cost-${itemIdx}`);
            if(cell) cell.innerText = calculateCost([item]).toFixed(2) + ' ‚Ç¨';
        });

        // 2. Update Calculations (Sur Place)
        const priceTTC = parseFloat(recipe.sellingPrice) || 0;
        const priceHT = priceTTC / (1 + (vatRate/100));
        const tvaAmount = priceTTC - priceHT;
        const marginVal = priceHT - cost;
        const marginPercent = priceHT > 0 ? (marginVal / priceHT) * 100 : 0;
        
        const wTva = priceTTC > 0 ? (tvaAmount / priceTTC) * 100 : 0;
        const wCost = priceTTC > 0 ? (cost / priceTTC) * 100 : 0;
        const wMargin = priceTTC > 0 ? (marginVal / priceTTC) * 100 : 0;

        // 3. Update Calculations (Livraison)
        const delivPriceTTC = parseFloat(recipe.deliveryPrice) || priceTTC;
        const delivPriceHT = delivPriceTTC / (1 + (vatRate/100));
        const delivTva = delivPriceTTC - delivPriceHT;
        const commPercent = parseFloat(recipe.commission) || 30;
        const commAmount = delivPriceTTC * (commPercent / 100);
        const delivMarginVal = delivPriceHT - cost - commAmount;
        const delivMarginPercent = delivPriceHT > 0 ? (delivMarginVal / delivPriceHT) * 100 : 0;

        const dwTva = delivPriceTTC > 0 ? (delivTva / delivPriceTTC) * 100 : 0;
        const dwComm = delivPriceTTC > 0 ? (commAmount / delivPriceTTC) * 100 : 0;
        const dwCost = delivPriceTTC > 0 ? (cost / delivPriceTTC) * 100 : 0;
        const dwMargin = delivPriceTTC > 0 ? (delivMarginVal / delivPriceTTC) * 100 : 0;

        // 4. Update DOM Elements (Sur Place)
        const setStyle = (id, width) => { const el = document.getElementById(id); if(el) el.style.width = Math.max(0, width) + '%'; };
        const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
        const setHtml = (id, val) => { const el = document.getElementById(id); if(el) el.innerHTML = val; };

        setStyle('bar-sp-tva', wTva);
        setStyle('bar-sp-cost', wCost);
        setStyle('bar-sp-margin', wMargin);
        
        setTxt('val-sp-tva', tvaAmount.toFixed(2) + ' ‚Ç¨');
        setTxt('val-sp-cost', cost.toFixed(2) + ' ‚Ç¨');
        setHtml('val-sp-margin', `${marginVal.toFixed(2)} ‚Ç¨ (${marginPercent.toFixed(0)}%)`);
        
        const rowSp = document.getElementById('row-sp-margin');
        if(rowSp) rowSp.style.color = marginPercent < 70 ? 'var(--danger)' : 'var(--success)';

        // 5. Update DOM Elements (Livraison)
        setStyle('bar-liv-tva', dwTva);
        setStyle('bar-liv-comm', dwComm);
        setStyle('bar-liv-cost', dwCost);
        setStyle('bar-liv-margin', dwMargin);

        setTxt('val-liv-tva', delivTva.toFixed(2) + ' ‚Ç¨');
        setTxt('val-liv-comm', commAmount.toFixed(2) + ' ‚Ç¨');
        setTxt('val-liv-cost', cost.toFixed(2) + ' ‚Ç¨');
        setHtml('val-liv-margin', `${delivMarginVal.toFixed(2)} ‚Ç¨ (${delivMarginPercent.toFixed(0)}%)`);

        const rowLiv = document.getElementById('row-liv-margin');
        if(rowLiv) rowLiv.style.color = delivMarginPercent < 30 ? '#f87171' : '#4ade80';
    }
}

function renderIntermediateRecipes() {
    const tabContainer = document.getElementById('int-sub-tabs');
    const contentContainer = document.getElementById('intermediateRecipeContent');
    const addBtn = document.createElement('button');
    addBtn.className = 'add-tab-btn'; addBtn.innerHTML = '+'; addBtn.onclick = createIntermediateRecipe;
    addBtn.title = "Nouvelle pr√©paration";
    tabContainer.innerHTML = '';
    if(state.intermediate.length === 0) {
        tabContainer.appendChild(addBtn);
        contentContainer.innerHTML = `<div class="empty-state">Aucune pr√©paration. Cr√©ez vos sauces ou bases ici.</div>`;
        return;
    }
    state.intermediate.forEach((recipe, i) => {
        const tab = document.createElement('button');
        tab.className = `sub-tab ${i === activeIntIndex ? 'active' : ''}`;
        tab.innerText = recipe.name;
        tab.onclick = () => switchSubTab('intermediate', i);
        tabContainer.appendChild(tab);
    });
    tabContainer.appendChild(addBtn);
    if(activeIntIndex >= state.intermediate.length) activeIntIndex = state.intermediate.length - 1;
    const recipe = state.intermediate[activeIntIndex];
    const index = activeIntIndex;
    if(recipe.lossPercent === undefined) recipe.lossPercent = 0;

    contentContainer.innerHTML = `
        <div style="padding-top:10px;">
             <div class="recipe-header">
                <input type="text" value="${recipe.name}" oninput="updateRecName('intermediate', ${index}, this.value)" style="font-weight:bold; font-size:1.3rem; width:auto; flex:1; padding:10px;">
                <button class="btn btn-danger" onclick="deleteRec('intermediate', ${index})"><i class="fas fa-trash"></i></button>
            </div>
            <table>
                <thead><tr><th>Ingr√©dient</th><th style="width:100px">Qt√©</th><th style="width:80px">Unit√©</th><th style="width:80px">Co√ªt</th><th></th></tr></thead>
                <tbody>
                    ${recipe.items.map((item, itemIdx) => `
                        <tr>
                            <td><select onchange="updateRecItem('intermediate', ${index}, ${itemIdx}, 'id', this.value)">${getIngredientSelectOptions(item.id, recipe.id)}</select></td>
                            <td><input type="number" step="0.1" value="${item.quantity}" oninput="updateRecItem('intermediate', ${index}, ${itemIdx}, 'quantity', this.value)"></td>
                            <td><select onchange="updateRecItem('intermediate', ${index}, ${itemIdx}, 'unit', this.value)">
                                <option value="g" ${item.unit==='g'?'selected':''}>g</option><option value="ml" ${item.unit==='ml'?'selected':''}>ml</option><option value="cl" ${item.unit==='cl'?'selected':''}>cl</option><option value="kg" ${item.unit==='kg'?'selected':''}>kg</option><option value="L" ${item.unit==='L'?'selected':''}>L</option>
                            </select></td>
                            <td style="color:var(--text-light); font-weight:600;">${calculateCost([item], new Set([recipe.id])).toFixed(2)} ‚Ç¨</td>
                            <td><button class="btn btn-outline btn-sm" style="color:var(--danger);border:none" onclick="removeRecItem('intermediate', ${index}, ${itemIdx})">‚úï</button></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div class="flex-between" style="margin-bottom:15px;">
                <button class="btn btn-sm btn-primary" onclick="addRecItem('intermediate', ${index})">+ Ingr√©dient</button>
                <div style="font-size:0.85rem; color:var(--text-light);">Poids th√©orique: <span id="int-theo-weight-${index}">...</span></div>
            </div>
            <div class="recipe-stats" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                <div class="stat-box">
                    <div class="stat-label">Co√ªt Total</div>
                    <div class="stat-value" id="int-cost-${index}">...</div>
                </div>
                <div class="stat-box">
                    <div class="flex-between" style="margin-bottom:5px;">
                        <span class="stat-label">Rendement & Perte</span>
                        <span id="int-badge-${index}"></span>
                    </div>
                    <div class="form-row" style="margin-bottom:0">
                         <div style="flex:1"><label style="font-size:0.7rem;">% Perte</label><input type="number" id="int-loss-input-${index}" oninput="updateRecField('intermediate', ${index}, 'lossPercent', this.value)"></div>
                        <div style="flex:1"><label style="font-size:0.7rem;">Poids Final</label><input type="number" id="int-yield-input-${index}" oninput="setManualYield(${index}); updateRecField('intermediate', ${index}, 'yield', this.value)"></div>
                         <div style="width:60px"><label style="font-size:0.7rem;">Unit√©</label><select onchange="updateRecField('intermediate', ${index}, 'yieldUnit', this.value)"><option value="g" ${recipe.yieldUnit==='g'?'selected':''}>g</option><option value="kg" ${recipe.yieldUnit==='kg'?'selected':''}>kg</option><option value="L" ${recipe.yieldUnit==='L'?'selected':''}>L</option><option value="ml" ${recipe.yieldUnit==='ml'?'selected':''}>ml</option></select></div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Co√ªt de revient</div>
                    <div class="stat-value" style="color:var(--primary)" id="int-pricekg-${index}">...</div>
                </div>
            </div>
        </div>
    `;
    updateRecipeCalculations('intermediate', index);
}

function renderFinalRecipes() {
    const tabContainer = document.getElementById('fin-sub-tabs');
    const contentContainer = document.getElementById('finalRecipeContent');
    const addBtn = document.createElement('button');
    addBtn.className = 'add-tab-btn'; addBtn.innerHTML = '+'; addBtn.onclick = createFinalRecipe;
    addBtn.title = "Nouveau plat";
    tabContainer.innerHTML = '';
    if(state.final.length === 0) {
        tabContainer.appendChild(addBtn);
        contentContainer.innerHTML = `<div class="empty-state">Aucun plat. Cliquez sur + pour commencer.</div>`;
        return;
    }
    state.final.forEach((recipe, i) => {
        const tab = document.createElement('button');
        tab.className = `sub-tab ${i === activeFinIndex ? 'active' : ''}`;
        tab.innerText = recipe.name;
        tab.onclick = () => switchSubTab('final', i);
        tabContainer.appendChild(tab);
    });
    tabContainer.appendChild(addBtn);
    if(activeFinIndex >= state.final.length) activeFinIndex = state.final.length - 1;
    const recipe = state.final[activeFinIndex];
    const index = activeFinIndex;

    // --- CALCULS POUR AFFICHAGE INITIAL ---
    // Note: These are just placeholders, the actual values are populated via updateRecipeCalculations
    // to ensure logic is centralized. However, we need initial structure with IDs.
    
    contentContainer.innerHTML = `
        <div style="padding-top:10px;">
            <div class="recipe-header">
                <input type="text" value="${recipe.name}" oninput="updateRecName('final', ${index}, this.value)" style="font-weight:bold; font-size:1.3rem; color:var(--primary-dark); width:auto; flex:1; padding:10px;">
                <button class="btn btn-danger" onclick="deleteRec('final', ${index})"><i class="fas fa-trash"></i></button>
            </div>

            <div style="margin-bottom: 30px;">
                <table>
                    <thead><tr><th>Composant</th><th>Qt√©</th><th>Unit√©</th><th>Co√ªt</th><th></th></tr></thead>
                    <tbody>
                        ${recipe.items.map((item, itemIdx) => `
                            <tr>
                                <td><select onchange="updateRecItem('final', ${index}, ${itemIdx}, 'id', this.value)">${getIngredientSelectOptions(item.id, null)}</select></td>
                                <td><input type="number" step="0.1" value="${item.quantity}" oninput="updateRecItem('final', ${index}, ${itemIdx}, 'quantity', this.value)"></td>
                                <td><select onchange="updateRecItem('final', ${index}, ${itemIdx}, 'unit', this.value)">
                                    <option value="g" ${item.unit==='g'?'selected':''}>g</option><option value="piece" ${item.unit==='piece'?'selected':''}>pce</option><option value="ml" ${item.unit==='ml'?'selected':''}>ml</option><option value="cl" ${item.unit==='cl'?'selected':''}>cl</option><option value="dl" ${item.unit==='dl'?'selected':''}>dl</option><option value="kg" ${item.unit==='kg'?'selected':''}>kg</option><option value="L" ${item.unit==='L'?'selected':''}>L</option>
                                </select></td>
                                <td id="fin-item-cost-${itemIdx}" style="font-size:0.85rem; color:var(--text-light); font-weight:600;">-- ‚Ç¨</td>
                                <td><button class="btn btn-outline btn-sm" style="color:var(--danger); border:none" onclick="removeRecItem('final', ${index}, ${itemIdx})">‚úï</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <button class="btn btn-sm btn-primary" onclick="addRecItem('final', ${index})">+ Composant</button>
            </div>

            <div class="form-row" style="justify-content: flex-end; align-items: center; margin-bottom: 20px;">
                <span style="font-weight: 600; margin-right: 10px;">TVA Applicable :</span>
                <input type="number" value="${recipe.vat}" oninput="updateRecField('final', ${index}, 'vat', this.value)" style="width: 60px; font-weight: bold;"> %
            </div>

            <div class="profit-grid">
                <!-- CARD SUR PLACE -->
                <div class="profit-card">
                    <div class="profit-header">
                        <div style="display:flex; align-items:center; gap:8px;"><i class="fas fa-store" style="color:var(--primary);"></i> Vente Sur Place</div>
                        <div class="flex-between" style="font-size:0.8rem; font-weight:400; gap:10px;">
                            Cible FC: <input type="number" style="width:40px; text-align:center; border:1px solid var(--border); border-radius:4px;" placeholder="%" onchange="updatePriceFromFC('final', ${index}, this.value, false)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="font-size:0.75rem; font-weight:700; text-transform:uppercase; color:var(--text-light);">Prix de Vente TTC Client</label>
                        <input type="number" step="0.1" value="${recipe.sellingPrice}" oninput="updateRecField('final', ${index}, 'sellingPrice', this.value)" style="font-size:1.5rem; font-weight:800; color:var(--text); padding:10px;">
                    </div>

                    <div class="money-bar">
                        <div id="bar-sp-tva" class="bar-segment bg-tva" style="width:0%" title="TVA">TVA</div>
                        <div id="bar-sp-cost" class="bar-segment bg-cost" style="width:0%" title="Mati√®re">Mat.</div>
                        <div id="bar-sp-margin" class="bar-segment bg-margin" style="width:0%" title="Marge">Marge</div>
                    </div>

                    <div class="legend-table">
                        <div class="legend-row"><div class="legend-label"><span class="dot bg-tva"></span> Part √âtat (TVA)</div> <span id="val-sp-tva">-- ‚Ç¨</span></div>
                        <div class="legend-row"><div class="legend-label"><span class="dot bg-cost"></span> Co√ªt Mati√®re</div> <span id="val-sp-cost">-- ‚Ç¨</span></div>
                        <div class="legend-row final-row" id="row-sp-margin">
                            <div class="legend-label"><span class="dot bg-margin"></span> Reste pour vous</div> 
                            <span id="val-sp-margin">-- ‚Ç¨</span>
                        </div>
                    </div>
                </div>

                <!-- CARD LIVRAISON -->
                <div class="profit-card dark-mode">
                    <div class="profit-header">
                        <div style="display:flex; align-items:center; gap:8px;"><i class="fas fa-motorcycle" style="color:#38bdf8;"></i> Vente Livraison</div>
                        <div class="flex-between" style="font-size:0.8rem; font-weight:400; gap:10px;">
                            Cible FC: <input type="number" style="width:40px; text-align:center; border:none; border-radius:4px; color:black;" placeholder="%" onchange="updatePriceFromFC('final', ${index}, this.value, true)">
                        </div>
                    </div>
                    <div class="form-row">
                        <div style="flex:2;">
                            <label style="font-size:0.75rem; font-weight:700; text-transform:uppercase; color:#94a3b8;">Prix Vente TTC</label>
                            <input type="number" step="0.1" value="${recipe.deliveryPrice || recipe.sellingPrice}" oninput="updateRecField('final', ${index}, 'deliveryPrice', this.value)" style="background:rgba(255,255,255,0.1); color:white; border:none; font-size:1.2rem; font-weight:bold;">
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:0.75rem; font-weight:700; text-transform:uppercase; color:#94a3b8;">Comm %</label>
                            <input type="number" value="${recipe.commission || 30}" oninput="updateRecField('final', ${index}, 'commission', this.value)" style="background:rgba(255,255,255,0.1); color:white; border:none; font-size:1.2rem; font-weight:bold;">
                        </div>
                    </div>

                    <div class="money-bar" style="opacity:0.9;">
                        <div id="bar-liv-tva" class="bar-segment bg-tva" style="width:0%" title="TVA"></div>
                        <div id="bar-liv-comm" class="bar-segment bg-comm" style="width:0%" title="Commission">Comm.</div>
                        <div id="bar-liv-cost" class="bar-segment bg-cost" style="width:0%" title="Mati√®re">Mat.</div>
                        <div id="bar-liv-margin" class="bar-segment bg-margin" style="width:0%" title="Marge"></div>
                    </div>

                    <div class="legend-table">
                        <div class="legend-row"><div class="legend-label"><span class="dot bg-tva"></span> Part √âtat</div> <span id="val-liv-tva">-- ‚Ç¨</span></div>
                        <div class="legend-row"><div class="legend-label"><span class="dot bg-comm"></span> Part Plateforme</div> <span id="val-liv-comm">-- ‚Ç¨</span></div>
                        <div class="legend-row"><div class="legend-label"><span class="dot bg-cost"></span> Co√ªt Mati√®re</div> <span id="val-liv-cost">-- ‚Ç¨</span></div>
                        <div class="legend-row final-row" id="row-liv-margin">
                            <div class="legend-label"><span class="dot bg-margin"></span> Reste pour vous</div> 
                            <span id="val-liv-margin">-- ‚Ç¨</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    // Initial calculation update to fill values
    updateRecipeCalculations('final', index);
}

function createIntermediateRecipe() {
    state.intermediate.push({ id: 'INT_' + Date.now(), name: "Nouvelle Recette", yield: 0, yieldUnit: 'g', items: [], manualYield: false, lossPercent: 0 });
    activeIntIndex = state.intermediate.length - 1;
    saveData(); renderIntermediateRecipes();
}

function createFinalRecipe() {
    state.final.push({ id: 'FIN_' + Date.now(), name: "Nouveau Plat", sellingPrice: 15.00, deliveryPrice: 18.00, vat: 10, commission: 30, clientFee: 2.99, serviceFee: 1.99, items: [] });
    activeFinIndex = state.final.length - 1;
    saveData(); renderFinalRecipes();
}

/* --- GENERIC HELPERS --- */
function addRecItem(type, index) {
    state[type][index].items.push({id: '', quantity: 1, unit: 'g'});
    saveData();
    if(type === 'intermediate') renderIntermediateRecipes(); else renderFinalRecipes();
}

function removeRecItem(type, recIndex, itemIndex) {
    state[type][recIndex].items.splice(itemIndex, 1);
    saveData();
    if(type === 'intermediate') renderIntermediateRecipes(); else renderFinalRecipes();
}

function updateRecName(type, index, val) {
    state[type][index].name = val; saveData();
    // Headers are re-rendered, so we might lose focus if editing name directly in a non-isolated way.
    // But here the name input is part of the full render.
    // For name update, we usually accept losing focus or use a different strategy. 
    // Given the request was about numbers/prices, this is acceptable or we can apply same ID fix.
    // Ideally name input should have an ID and be updated without re-render too.
    // But let's stick to the requested fix for now.
}

function updateRecField(type, index, field, val) {
    state[type][index][field] = parseFloat(val) || val;
    if (type === 'intermediate') {
        if(field === 'lossPercent') { state[type][index].manualYield = false; } 
    }
    saveData();
    updateRecipeCalculations(type, index); 
}

function updateRecItem(type, recIdx, itemIdx, field, val) {
    if (field === 'id') val = val.startsWith('INT_') ? val : parseInt(val);
    else if (field === 'quantity') val = parseFloat(val);
    state[type][recIdx].items[itemIdx][field] = val;
    saveData();
    updateRecipeCalculations(type, recIdx);
}

function updatePriceFromFC(type, index, targetFC, isDelivery) {
    const recipe = state[type][index];
    const cost = calculateCost(recipe.items, new Set([recipe.id])); 
    const vatRate = parseFloat(recipe.vat) || 0;
    const target = parseFloat(targetFC);

    if (target > 0 && cost > 0) {
        // Price HT = Cost / (Target% / 100)
        const priceHT = cost / (target / 100);
        const priceTTC = priceHT * (1 + (vatRate / 100));
        
        if (isDelivery) {
            recipe.deliveryPrice = priceTTC.toFixed(2);
        } else {
            recipe.sellingPrice = priceTTC.toFixed(2);
        }
        saveData();
        renderFinalRecipes();
    }
}

function setManualYield(index) { 
    state.intermediate[index].manualYield = true; 
    saveData(); 
    document.getElementById(`int-badge-${index}`).innerHTML = '<span class="badge badge-manual">Manuel</span>'; 
}

</script>
</body>
</html>
